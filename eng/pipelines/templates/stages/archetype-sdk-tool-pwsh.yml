parameters:
  - name: TargetDirectory
    type: string
  - name: TestFiles
    type: object
    default: []
  - name: CustomTestSteps
    type: object
    default: []
  - name: EnvVars
    type: object
    default: {}

variables:
  
  - template: /eng/pipelines/templates/variables/globals.yml
  

stages:
  - stage: 'Test'
    jobs:
      - job: 'Test'

        strategy:
          matrix:
            Windows:
              Pool: 'azsdk-pool-mms-ubuntu-2004-general'
              vmImage: 'MMSUbuntu20.04'
            Linux:
              Pool: 'azsdk-pool-mms-win-2019-general'
              vmImage: 'MMS2019'
            Mac:
              Pool: 'Azure Pipelines'
              Image: 'macOS-10.15'

        pool:
          name: $(Pool)
          vmImage: $(Image)

        steps:
          - pwsh: |
              Install-Module -Name Pester -Force
            displayName: Install Pester

          # default test steps
          - ${{ if eq(length(parameters.CustomTestSteps), 0) }}:
            - pwsh: |
                $configurations = '${{ convertToJson(parameters.TestFiles) }}' -replace '\\', '/' | ConvertFrom-Json
                Write-Host "$($configurations)"

                $config = New-PesterConfiguration
                $config.CodeCoverage.Enabled = $true
                $config.TestResult.Enabled = $true
                
                # if we are internal, etc, we need to set `integration tag`
                # let's simply start with a single tag, "Unit"
                $config.Filter.Tag = @("Unit")

                Invoke-Pester -Configuration $config
              displayName: Run Tests
              env: ${{ parameters.EnvVars }}
              workingDirectory: $(Build.SourcesDirectory)/${{ parameters.TargetDirectory }}

          - ${{ if not(eq(length(parameters.CustomTestSteps), 0)) }}:
            - ${{ parameters.CustomTestSteps }}

          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: succeededOrFailed()
            workingDirectory: $(Build.SourcesDirectory)/${{ parameters.TargetDirectory }}
            inputs:
              testResultsFormat: 'NUnit'
              testResultsFiles: testResults.xml
              testRunTitle: 'Tests_$(Image)'

          - task: PublishCodeCoverageResults@1
            displayName: 'Publish Code Coverage to Azure DevOps'
            workingDirectory: $(Build.SourcesDirectory)/${{ parameters.TargetDirectory }}
            inputs:
              codeCoverageTool: 'JaCoCo'
              summaryFileLocation: 'coverage.xml'
              pathToSources: '$(Build.SourcesDirectory)/${{ parameters.TargetDirectory }}'