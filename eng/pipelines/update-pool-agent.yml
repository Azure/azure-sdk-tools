parameters:
- name: Repos
  type: object
  default:
    - RepoOwner: Azure
      RepoName: azure-sdk-for-android
    - RepoOwner: Azure
      RepoName: azure-sdk-for-c
    - RepoOwner: Azure
      RepoName: azure-sdk-for-cpp
    - RepoOwner: Azure
      RepoName: azure-sdk-for-go
    - RepoOwner: Azure
      RepoName: azure-sdk-for-ios
    - RepoOwner: Azure
      RepoName: azure-sdk-for-java
    - RepoOwner: Azure
      RepoName: azure-sdk-for-js
    - RepoOwner: Azure
      RepoName: azure-sdk-for-net
    - RepoOwner: Azure
      RepoName: azure-sdk-for-python
- name: MigrateFrom
  type: string
  default: 'not-specified'
- name: MigrateTo
  type: string
  default: 'not-specified'

trigger: none
pr: none

jobs:
  - job: Migration
    pool:
      name: azsdk-pool-mms-ubuntu-2004-general
    variables:
      - template: ./templates/variables/globals.yml
    steps:
      - ${{ each repo in parameters.Repos }}:
        - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
          parameters:
            SkipCheckoutNone: true
            Repositories:
              - Name: ${{ repo.RepoOwner }}/${{ repo.RepoName }}
                WorkingDirectory: $(Build.SourcesDirectory)/docs
        - template: /eng/common/pipelines/templates/steps/set-default-branch.yml
        - pwsh: |
            Write-Host "checking $(DefaultBranch)"
            git ls-tree -r --name-only main
            Write-Host "getting all files"
            # Scan all Files
            foreach ($file in $files) {
              Write-Host $file
              $content = Get-Content $file -Raw
              $newcontent = ""
              if ($content -match "${{ parameters.MigrateFrom }}") {
                Write-Host $file
                $newcontent = $content -replace "${{ parameters.MigrateFrom }}", "${{ parameters.MigrateTo }}"
                Set-Content -Path $file -Value $newcontent
              }
            }
          displayName: Update pool version from ${{ parameters.MigrateFrom }} to ${{ parameters.MigrateTo }}
          workingDirectory: $(Build.SourcesDirectory)/docs
        - template: /eng/common/pipelines/templates/steps/create-pull-request.yml
          parameters:
            BaseBranchName: $(DefaultBranch)
            PRBranchName: migrate-pool
            CommitMsg: "Migrate from ${{ parameters.MigrateFrom }} to ${{ parameters.MigrateTo }}"
            RepoOwner: ${{ repo.RepoOwner }}
            RepoName: ${{ repo.RepoName }}
            OpenAsDraft: true
            WorkingDirectory: $(Build.SourcesDirectory)/docs
          