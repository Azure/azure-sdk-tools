jobs:
  - job: testnetiso
    pool:
      name: bebroder-test-netiso
    displayName: test-netiso
    steps:
      - checkout: self
      - task: AzureCLI@2
        displayName: NetIso
        inputs:
          azureSubscription: azure-sdk-tests
          azurePowerShellVersion: LatestVersion
          scriptType: pscore
          scriptLocation: inlineScript
          inlineScript: |
            $ITERATION = "2"
            $GROUP = "bebroder-test-netiso-storage"
            $OPENACCOUNT = "bebrodernetisoopen$ITERATION"
            $CLOSEDACCOUNT = "bebrodernetisoclosed$ITERATION"
            $CROSSREGIONACCOUNT = "bebrodernetisocross$ITERATION"
            $CONTAINER = "test"
            $BLOB = "test"

            az account set -s "Azure SDK Test Resources"

            Write-Host "Getting key for open account open"
            $KEY = az storage account keys list --resource-group $GROUP --account-name $OPENACCOUNT --query '[0].value' -o tsv
            Write-Host "Downloading blob from open account"
            az storage blob download  --account-name $OPENACCOUNT --account-key $KEY --container-name $CONTAINER --file testdataopen --name $BLOB -o tsv
            Write-Host "Printing data from open account"
            cat testdataopen

            Write-Host "Getting key from net iso account closed"
            $KEY = az storage account keys list --resource-group $GROUP --account-name $CLOSEDACCOUNT --query '[0].value' -o tsv
            Write-Host "Downloading blob from net iso account closed"
            az storage blob download  --account-name $CLOSEDACCOUNT --account-key $KEY --container-name $CONTAINER --file testdataclosed --name $BLOB -o tsv
            Write-Host "Printing data from net iso account closed"
            cat testdataclosed

            Write-Host "Getting key from net iso account cross"
            $KEY = az storage account keys list --resource-group $GROUP --account-name $CROSSREGIONACCOUNT --query '[0].value' -o tsv
            Write-Host "Downloading blob from net iso account cross"
            az storage blob download  --account-name $CROSSREGIONACCOUNT --account-key $KEY --container-name $CONTAINER --file testdatacross --name $BLOB -o tsv
            Write-Host "Printing data from net iso account cross"
            cat testdatacross
