# Mirror the eng/common folder to all subscribed langauge repos.
parameters:
- name: PRDataFileName
  type: string
  default: PRsCreated.txt
- name: ArtifactName
  type: string
  default: pullrequestdata
- name: DirectoryToSync
  type: string
  default: eng/common

trigger: none

pr:
  branches:
    include:
      - master
  paths:
    include:
      - eng/common

pool:
  vmImage: windows-2019

stages:
  - stage: CreateSync
    jobs:
      - job: SyncEngCommon
        displayName: Sync ${{ parameters.DirectoryToSync }} Directory

        steps:
        - ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
          - pwsh: |
              Set-PsDebug -Trace 1
              $patchDir = "$(Build.ArtifactStagingDirectory)/patchfiles"
              $patchfiles = git format-patch --output-directory $patchDir HEAD...origin/$(system.pullRequest.targetBranch) -- "${{ parameters.DirectoryToSync }}"
              if ($patchfiles -and ($LASTEXITCODE -eq 0)) {
                echo "##vso[task.setvariable variable=PatchFilesLocation]$patchDir"
                echo "Setting PatchFilesLocation"
              }
              else {
                Write-Host "Failed to Create PatchFiles from Pull Request [https://github.com/Azure/azure-sdk-tools/pull/$(System.PullRequest.PullRequestNumber)]"
                exit 1
              }
            displayName: Create Patch Files from Changes in PR
            workingDirectory: $(System.DefaultWorkingDirectory)

          - task: PublishPipelineArtifact@1
            condition: and(succeeded(), ne(variables['PatchFilesLocation'],''))
            inputs:
              artifactName: patchfiles
              path: "$(PatchFilesLocation)"

        - template: ./templates/steps/sync-directory.yml
          parameters:
            ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
              CommitMessage: "Sync ${{ parameters.DirectoryToSync }} directory with azure-sdk-tools repository for Tools PR $(System.PullRequest.PullRequestNumber)"
              DirectoryToSync: ${{ parameters.DirectoryToSync }}
              PRBranchName: "sync-${{ parameters.DirectoryToSync }}-$(System.PullRequest.SourceBranch)-$(System.PullRequest.PullRequestNumber)"
              BaseBranchName: $(system.pullRequest.targetBranch) 
              PRTitle: "Sync ${{ parameters.DirectoryToSync }} directory with azure-sdk-tools for PR $(System.PullRequest.PullRequestNumber)"
              PRBody: >
                Sync ${{ parameters.DirectoryToSync }} directory with azure-sdk-tools for PR https://github.com/Azure/azure-sdk-tools/pull/$(System.PullRequest.PullRequestNumber)<br>
                See [eng/common workflow](https://github.com/Azure/azure-sdk-tools/blob/master/eng/common/README.md#workflow)
              SkipCheckingForChanges: true
            ${{ if ne(variables['Build.Reason'], 'PullRequest') }}:
              CommitMessage: Sync ${{ parameters.DirectoryToSync }} directory with azure-sdk-tools repository
              DirectoryToSync: ${{ parameters.DirectoryToSync }}
              PRBranchName: "sync-${{ parameters.DirectoryToSync }}"
              PRTitle: Sync ${{ parameters.DirectoryToSync }} directory with azure-sdk-tools repository
              PRBody: >
                Sync ${{ parameters.DirectoryToSync }} directory with azure-sdk-tools repository.<br>
                See [eng/common workflow](https://github.com/Azure/azure-sdk-tools/blob/master/eng/common/README.md#workflow)
            PRDataArtifactPath: $(Build.ArtifactStagingDirectory)/${{ parameters.PRDataFileName }}
            Repos:
              - azure-sdk-for-android
              - azure-sdk-for-c
              - azure-sdk-for-cpp
              - azure-sdk-for-go
              - azure-sdk-for-ios
              - azure-sdk-for-java
              - azure-sdk-for-js
              - azure-sdk-for-net
              - azure-sdk-for-python

        - task: PublishPipelineArtifact@1
          condition: succeeded()
          inputs:
            artifactName: ${{ parameters.ArtifactName }}
            path: $(Build.ArtifactStagingDirectory)/${{ parameters.PRDataFileName }}

  - stage: VerifyAndMerge
    jobs:
      - deployment: VerifyandMergeSyncPrs
        displayName: Verify and Merge Sync PRs
        environment: github

        pool:
          vmImage: windows-2019

        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - download: current
                  artifact: ${{parameters.ArtifactName}}
                  displayName: Download ${{ parameters.PRDataFileName }}

                - task: PowerShell@2
                  displayName: 'Verify then Merge Pull Requests'
                  inputs:
                    targetType: filePath
                    filePath: $(Build.SourcesDirectory)/eng/scripts/Verify-And-Merge-PRs.ps1
                    arguments: >
                      -PRDataArtifactPath "$(Pipeline.Workspace)/${{parameters.ArtifactName}}/${{ parameters.PRDataFileName }}"
                      -AuthToken "$(azuresdk-github-pat)"
                      -devOpsLogging
                    pwsh: true