# NOTE: Please refer to https://aka.ms/azsdk/engsys/ci-yaml before editing this file.
trigger:
  branches:
    include:
      - main
      - feature/*
      - release/*
      - hotfix/*
  paths:
    include:
      - tools/apiview/parsers/cpp-api-parser

pr:
  branches:
    include:
      - main
      - feature/*
      - release/*
      - hotfix/*
  paths:
    include:
      - tools/apiview/parsers/cpp-api-parser

variables:
  NodeVersion: '16.x'
  TypeScriptGeneratorDirectory: 'tools/apiview/parsers/js-api-parserts-genapi'
  ArtifactName: 'apiview'
  VcpkgRelease: '2022.11.14'
  FeedRegistry: 'https://pkgs.dev.azure.com/azure-sdk/public/_packaging/azure-sdk-for-cpp/'

stages:
  - stage: 'Build'
    jobs:
      - job: 'Build'
        timeoutInMinutes: 300
        pool:
          name: azsdk-pool-mms-win-2019-general
          vmImage: MMS2019

        steps:
          - pwsh: |
              cmd /c dir c:\
              cmd /c dir d:\
              Write-Host "git clone https://github.com/Microsoft/vcpkg"
              git clone https://github.com/Microsoft/vcpkg
              if ($LASTEXITCODE -ne 0) {
                Write-Error "Unable to check out vcpkg fork repo"
                exit $LASTEXITCODE
              }
              cd ./vcpkg
              git fetch --tags
              git checkout tags/$(VcpkgRelease)
            displayName: Clone vcpkg 
            workingDirectory: '${Build.SourcesDirectory}'
          - pwsh: |
                ./vcpkg/bootstrap-vcpkg
            displayName: Bootstrap vcpkg.
            condition: succeeded()
            workingDirectory: '${Build.SourcesDirectory}'
          - pwsh: |
              $vcpkgRoot = Resolve-Path "./vcpkg"
              Write-Host "Set VCPKG_ROOT: $vcpkgRoot"
              Write-Host "##vso[task.setvariable variable=VCPKG_ROOT]$vcpkgRoot"
            displayName: Set VCPKG_ROOT
            condition: succeeded()
          - pwsh: mkdir build
            displayName: Create cmake build directory.
            workingDirectory: ${Build.SourcesDirectory}/tools/apiview/parsers/cpp-api-parser
            condition: succeeded()
          - pwsh: |
              cmake.exe -G "Ninja" -DCMAKE_C_COMPILER:STRING="cl.exe" -DCMAKE_CXX_COMPILER:STRING="cl.exe" -DCMAKE_CXX_STANDARD:STRING="20" -DCMAKE_TOOLCHAIN_FILE:STRING=${env:VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake -DVCPKG_BUILD_TYPE:STRING="release" -DVCPKG_OVERLAY_TRIPLETS:STRING="../vcpkg-triplets" -DMSVC_RUNTIME_LIBRARY:STRING="MultiThreadedDebug" -DVCPKG_TARGET_TRIPLET:STRING="x64-windows-static-release" -DCMAKE_INSTALL_PREFIX:PATH="$(Build.SourcesDirectory)/build" ..
            displayName: CMAKE Generate.
            workingDirectory: ${Build.SourcesDirectory}/tools/apiview/parsers/cpp-api-parser/build
            condition: succeeded()
          - pwsh: |
              cmake.exe --build $(Build.SourcesDirectory)/build --config Release --target cpp-api-parser
            displayName: Build ApiView Parser.
            workingDirectory: ${Build.SourcesDirectory}/tools/apiview/parsers/cpp-api-parser/build
            condition: succeeded()
          - pwsh: |
                $cppApiParser = Resolve-Path "${Build.SourcesDirectory}/build/bin/Release/cpp-api-parser.exe"
                Write-Host "Set CPP_API_PARSER: $cppApiParser"
                Write-Host "##vso[task.setvariable variable=CPP_API_PARSER]$cppApiParser"
            workingDirectory: ${Build.SourcesDirectory}/tools/apiview/parsers/cpp-api-parser
            condition: succeeded()
  #- stage: 'Publish'
  #  jobs:
  #    - job: 'Build Prerequisites - cmake'
  #      pool:
  #        name: azsdk-pool-mms-win-2019-general
  #        vmImage: MMS2019
  #      steps:
  #        - task: PublishBuildArtifacts@1
  #          inputs:
  #            pathtoPublish: '$(Build.ArtifactStagingDirectory)'
  #            artifactName: $(ArtifactName)

  - ${{if and(eq(variables['Build.Reason'], 'Manual'), eq(variables['System.TeamProject'], 'internal'))}}:
    - stage: 'Release'
      dependsOn: Build
      condition: Succeeded()
      jobs:
      - job: PublishPackage
        displayName: 'Publish ts-genapi package to devops feed'
        pool:
          name: azsdk-pool-mms-ubuntu-2004-general
          vmImage: MMSUbuntu20.04
        steps:
        - checkout: none
        - download: current
        
        - pwsh: |
            $detectedPackageName=Get-ChildItem $(Pipeline.Workspace)/$(ArtifactName)/*.tgz
            Write-Host "Detected package name: $detectedPackageName"
            $registry="$(FeedRegistry)"
            $regAuth=$registry.replace("https:","")
            $npmReg = $regAuth.replace("registry/","");
            $env:NPM_TOKEN="$(azure-sdk-devops-npm-token)"
            Write-Host "Publishing to $($regAuth)"
            npm config set $regAuth`:username=azure-sdk
            npm config set $regAuth`:_password=`$`{NPM_TOKEN`}
            npm config set $regAuth`:email=not_set
            npm config set $npmReg`:username=azure-sdk
            npm config set $npmReg`:_password=`$`{NPM_TOKEN`}
            npm config set $npmReg`:email=not_set
            Write-Host "Publishing package"
            Write-Host "npm publish $detectedPackageName --registry=$registry --always-auth=true"
            npm publish $detectedPackageName --registry=$registry --always-auth=true
          displayName: Publish package
