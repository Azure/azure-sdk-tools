# The keyvault secret provider (https://github.com/Azure/secrets-store-csi-driver-provider-azure)
# uses the csi storage driver interface to provide secrets to pods.
# While the secret provider class is configured to create a secret resource
# matching the keyvault secret, due to the storage provider interface design
# the controller will only react to volume mounting events.
# This deployment is created as a workaround to simplify stress test job definitions
# and allow them to only define a secretKeyRef (no volume mounts).
apiVersion: apps/v1
kind: Deployment
metadata:
  name: secret-volume-mounter
  namespace: {{ .Release.Namespace }}
  labels:
    class: stress-secrets
spec:
  replicas: 1
  selector:
    matchLabels:
      class: stress-secrets-mounter
  template:
    metadata:
      labels:
        class: stress-secrets-mounter
    spec:
      containers:
      - name: busybox
        image: k8s.gcr.io/e2e-test-images/busybox:1.29
        command:
          - "sh"
        args:
          - "-c"
          - "while true; do sleep 86400; done"
        env:
          # This env var is unnecessary, but useful for validation
          - name: APPINSIGHTS_INSTRUMENTATIONKEY
            valueFrom:
              secretKeyRef:
                name: appinsightsinstrumentationkey
                key: value
        volumeMounts:
        - name: secrets-store-inline
          mountPath: "/mnt/secrets-store"
          readOnly: true
      volumes:
        - name: secrets-store-inline
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: stress-kv
