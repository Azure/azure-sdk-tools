trigger: none
pr: none

pool:
  name: azsdk-pool-mms-ubuntu-2204-general
  vmImage: ubuntu-22.04

variables:
  cachefile: verify-links-cache-test.txt

jobs:
- job: CheckLinks
  displayName: Check and Cache Links
  timeoutInMinutes: 360
  steps:
       
  - task: PowerShell@2
    displayName: 'tools link check'
    condition: succeededOrFailed()
    inputs:
      pwsh: true
      filePath: eng/common/scripts/Verify-Links.ps1
      arguments: >
        -urls (Get-ChildItem -Path ./eng/common -Recurse -Include *.md)
        -rootUrl "file://$(System.DefaultWorkingDirectory)"        
        -ignoreLinksFile "./eng/pipelines/githubio-linkcheck-ignore-links.txt"
        -inputCacheFile "$(cachefile)"
        -outputCacheFile "$(cachefile)"
        -devOpsLogging: $true

  - publish: $(cachefile)
    artifact: verify-links-cache.txt
    condition: succeededOrFailed()
    displayName: Upload verified links

  - task: AzurePowerShell@5
    displayName: 'Upload cache file to blob container'
    inputs:
      azureSubscription: 'Azure SDK Artifacts'
      ScriptType: 'InlineScript'
      azurePowerShellVersion: LatestVersion 
      pwsh: true
      Inline: |
        azcopy copy '$(cachefile)' 'https://azuresdkartifacts.blob.core.windows.net/verify-links-cache'
    env: 
      AZCOPY_AUTO_LOGIN_TYPE: 'PSCRED'

  - task: AzureFileCopy@6
    displayName: 'Upload cache file to blob container'
    inputs:
      sourcePath: '$(cachefile)'
      azureSubscription: 'Azure SDK Artifacts'
      destination: AzureBlob
      storage: azuresdkartifacts
      containerName: 'verify-links-cache'
      
 # - pwsh: |
 #     azcopy copy '$(cachefile)' 'https://azuresdkartifacts.blob.core.windows.net/verify-links-cache$(azuresdkartifacts-verify-links-cache-sas)'
 #   condition: succeededOrFailed()
 #   displayName: Upload cache file to blob container
