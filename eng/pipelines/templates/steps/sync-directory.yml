parameters:
  Repos: []
  DirectoryToSync: eng/common
  CommitMessage: commit-message-not-set
  PRBranchName: branch-name-not-set
  BaseBranchName: master
  PRTitle: pr-title-not-set
  PRBody: pr-body-not-set
  PRDataArtifactPath: pr-data-artifact-path-not-set
  SkipCheckingForChanges: false

steps:
  - pwsh: |
      New-Item -Path ${{ parameters.PRDataArtifactPath }} -ItemType File
    displayName: Create PRData Artifact

  - ${{ each repo in parameters.Repos }}:
    - pwsh: |
        Set-PsDebug -Trace 1
        git clone --branch ${{ parameters.BaseBranchName }} https://github.com/azure/${{ repo }}
        $repoPath = "${{ repo }}/${{ parameters.DirectoryToSync }}"
        if ('$(PatchFilesLocation)')
        {
          pushd ${{ repo }}
          $results = @()
          echo "##vso[task.setvariable variable=HasChanges]$false"
          $shaBeforePatches = git rev-parse --short HEAD
          Write-Host $shaBeforePatches
          foreach ($file in (Get-ChildItem $(PatchFilesLocation)))
          {
             Write-Host $file.FullName
             git -c user.name="azure-sdk" -c user.email="azuresdk@microsoft.com" am -3 $file.FullName
             if ($lastExitCode -ne 0) { 
               git am --show-current-patch=diff
               Write-Error "##vso[task.LogIssue type=warning;]Failed to properly apply patch files to [https://github.com/azure/${{ repo }}]"
               exit 1
             }
          }
          $shaAfterPatches = git rev-parse --short HEAD
          Write-Host $shaAfterPatches
          $hasChanges = $shaBeforePatches -ne $shaAfterPatches
          echo "##vso[task.setvariable variable=HasChanges]$hasChanges"
        }
        else
        {
          if (!(Test-Path $repoPath)) { mkdir $repoPath }
          Remove-Item -v -r $repoPath
          Copy-Item -v -r $(Build.SourcesDirectory)/${{ parameters.DirectoryToSync }} $repoPath
          Get-ChildItem -r $repoPath
        }
      displayName: Copy ${{ parameters.DirectoryToSync }} from azure-sdk-tools to ${{ repo }}
      workingDirectory: $(System.DefaultWorkingDirectory)

    - template: /eng/common/pipelines/templates/steps/create-pull-request.yml
      parameters:
        RepoName: ${{ repo }}
        RepoOwner: Azure
        PRBranchName: ${{ parameters.PRBranchName }}
        BaseBranchName: ${{ parameters.BaseBranchName }}
        CommitMsg: ${{ parameters.CommitMessage }}
        PRTitle: ${{ parameters.PRTitle }}
        PRBody: ${{ parameters.PRBody }}
        PRLabels: "EngSys"
        PushArgs: -f
        WorkingDirectory: $(System.DefaultWorkingDirectory)/${{ repo }}
        ScriptDirectory: $(System.DefaultWorkingDirectory)/eng/common/scripts
        GHReviewersVariable: "System.PullRequest.Creator"
        GHAssignessVariable: "System.PullRequest.Creator"
        SkipCheckingForChanges: ${{ parameters.SkipCheckingForChanges }}

    - pwsh: |
        $PRData = "Azure;${{ repo }};$(Submitted.PullRequest.Number)"
        Add-Content -Path ${{ parameters.PRDataArtifactPath }} -Value $PRData
      displayName: Write Sync PR Data to Artifact File
      condition: and(succeeded(), eq(variables['HasChanges'], 'true'))
