name: Run switched packages content validation for java
trigger: none

parameters:
- name: packages
  displayName: |
      Comma-delimited list of packages to test against (by default, 'all' to run all). Example: 'azure-ai-contentsafety, azure-ai-documentintelligence'. Notes: If you select "all", two pipelines will be triggered. The first pipeline will be used to obtain the package to be tested, and then the second pipeline will be automatically triggered to run the test. You need to view the results in the automatically triggered pipeline.
  type: string
  default: 'all'

- name: maxParallel
  displayName: |
      Maximum number of parallel jobs to run (by default, 2). Example: 10
  type: number
  default: 2

- name: packagesListFilePath
  displayName: Path to packages.json file
  type: string
  default: 'packagesList.txt'

- name: selectedRule
  displayName: "Select one validation rule to run test"
  type: string
  default: 'ExtraLabel'
  values:
  - InconsistentTextFormat
  - TableMissingContent
  - GarbledText
  - ExtraLabel
  - UnnecessarySymbols
  - MissingGenerics

- name: createIssue
  displayName: Create issue for this run.
  type: boolean
  default: false


stages:
- stage: Content_Validation_Test
  displayName: "Content Validation Test"
  jobs:
  - job: FetchLastMonthReleasedPackages
    displayName: "Getting all packages to be tested"
    condition: eq('${{ parameters.packages }}', 'all')
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: UseDotNet@2
      displayName: 'Install .NET Core SDK'
      inputs:
        packageType: 'sdk'
        version: '9.0.x'
        installationPath: $(Agent.ToolsDirectory)/dotnet 

    - task: DotNetCoreCLI@2
      displayName: New Manifest for tool
      inputs:
        command: custom
        custom: 'new '
        arguments: tool-manifest

    - task: DotNetCoreCLI@2
      displayName: Install Playwright CLI
      inputs:
        command: custom
        custom: 'tool '
        arguments: install Microsoft.Playwright.CLI

    - task: DotNetCoreCLI@2
      displayName: Build all projects and libraries
      inputs:
        command: 'build'
        projects: '$(System.DefaultWorkingDirectory)/tools/content-validation/content-validation.sln'

    - task: DotNetCoreCLI@2
      displayName: Run Playwright Install
      inputs:
        command: custom
        custom: 'tool '
        arguments: run playwright install

    - task: DotNetCoreCLI@2
      displayName: Running project PendingTestingPackagesThisMonth
      env:
        Language: 'Java'
        PackagesListFilePath: ${{ parameters.packagesListFilePath }}
      inputs:
        command: 'run'
        workingDirectory: '$(System.DefaultWorkingDirectory)/tools/content-validation/PendingTestingPackagesThisMonth'
      name: runPackagesJob

    - pwsh: |
        $packagesJson = Get-Content "$(System.DefaultWorkingDirectory)/tools/content-validation/${{ parameters.packagesListFilePath }}" -Raw
        
        if ($packagesJson -notmatch '^\s*\{') {
          $packages = $packagesJson -split ',' | ForEach-Object { $_.Trim() }
          $matrix = @{}
          foreach ($pkg in $packages) {
            if ($pkg) {
              $matrix[$pkg] = @{ packageName = $pkg }
            }
          }
        } else {
          $matrix = $packagesJson | ConvertFrom-Json -AsHashtable
        }
        
        $matrixJson = $matrix | ConvertTo-Json -Compress
        Write-Host "Generated matrix: $matrixJson"
        Write-Host "##vso[task.setvariable variable=matrix;isOutput=true]$matrixJson"
      name: generateMatrix

  - job: content_validation_matrix_all
    displayName: RunTest_All
    condition: eq('${{ parameters.packages }}', 'all')
    dependsOn: FetchLastMonthReleasedPackages
    timeoutInMinutes: 180
    strategy:
      matrix: $[ dependencies.FetchLastMonthReleasedPackages.outputs['generateMatrix.matrix'] ]
      maxParallel: ${{ parameters.maxParallel }}
    variables:
      PackageName: $(packageName)
    pool:
      vmImage: ubuntu-latest
    steps:
    - script: |
        rules=""
        runTestCase=""

        case "${{ parameters.selectedRule }}" in
          "InconsistentTextFormat")
            runTestCase="TestInconsistentTextFormat"
            if [ "$(echo ${{ parameters.createIssue }} | tr '[:upper:]' '[:lower:]')" = "true" ]; then
              rules="InconsistentTextFormatValidation"
            fi
            ;;
          "TableMissingContent")
            runTestCase="TestTableMissingContent"
            if [ "$(echo ${{ parameters.createIssue }} | tr '[:upper:]' '[:lower:]')" = "true" ]; then
              rules="MissingContentValidation"
            fi
            ;;
          "GarbledText")
            runTestCase="TestGarbledText"
            if [ "$(echo ${{ parameters.createIssue }} | tr '[:upper:]' '[:lower:]')" = "true" ]; then
              rules="GarbledTextValidation"
            fi
            ;;
          "ExtraLabel")
            runTestCase="TestExtraLabel"
            if [ "$(echo ${{ parameters.createIssue }} | tr '[:upper:]' '[:lower:]')" = "true" ]; then
              rules="ExtraLabelValidation"
            fi
            ;;
          "UnnecessarySymbols")
            runTestCase="TestUnnecessarySymbols"
            if [ "$(echo ${{ parameters.createIssue }} | tr '[:upper:]' '[:lower:]')" = "true" ]; then
              rules="UnnecessarySymbolsValidation"
            fi
            ;;
          "MissingGenerics")
            runTestCase="TestMissingGenerics"
            if [ "$(echo ${{ parameters.createIssue }} | tr '[:upper:]' '[:lower:]')" = "true" ]; then
              rules="MissingGenericsValidation"
            fi
            ;;
        esac


        echo "Selected rules: $rules"
        echo "##vso[task.setvariable variable=SelectedRules]$rules"

        echo "Selected test case: $runTestCase"
        echo "##vso[task.setvariable variable=RunTestCase]$runTestCase"
      name: setRules

    - template: ../common/content-validation-for-java.yml
      parameters:
        packageName: $(PackageName)
        rules: $(SelectedRules)
        runTestCase: $(RunTestCase)

  - job: content_validation_matrix_not_all
    displayName: RunTest_Not_All
    condition: ne('${{ parameters.packages }}', 'all')
    timeoutInMinutes: 180
    strategy:
      matrix:
        ${{ each pkg in split(parameters.packages, ',') }}:
          ${{ trim(pkg) }}:
            packageName: ${{ trim(pkg) }}
      maxParallel: ${{ parameters.maxParallel }}
    variables:
      PackageName: $(packageName)
    pool:
      vmImage: ubuntu-latest
    steps:
    - script: |
        rules=""
        runTestCase=""

        case "${{ parameters.selectedRule }}" in
          "InconsistentTextFormat")
            runTestCase="TestInconsistentTextFormat"
            if [ "$(echo ${{ parameters.createIssue }} | tr '[:upper:]' '[:lower:]')" = "true" ]; then
              rules="InconsistentTextFormatValidation"
            fi
            ;;
          "TableMissingContent")
            runTestCase="TestTableMissingContent"
            if [ "$(echo ${{ parameters.createIssue }} | tr '[:upper:]' '[:lower:]')" = "true" ]; then
              rules="MissingContentValidation"
            fi
            ;;
          "GarbledText")
            runTestCase="TestGarbledText"
            if [ "$(echo ${{ parameters.createIssue }} | tr '[:upper:]' '[:lower:]')" = "true" ]; then
              rules="GarbledTextValidation"
            fi
            ;;
          "ExtraLabel")
            runTestCase="TestExtraLabel"
            if [ "$(echo ${{ parameters.createIssue }} | tr '[:upper:]' '[:lower:]')" = "true" ]; then
              rules="ExtraLabelValidation"
            fi
            ;;
          "UnnecessarySymbols")
            runTestCase="TestUnnecessarySymbols"
            if [ "$(echo ${{ parameters.createIssue }} | tr '[:upper:]' '[:lower:]')" = "true" ]; then
              rules="UnnecessarySymbolsValidation"
            fi
            ;;
          "MissingGenerics")
            runTestCase="TestMissingGenerics"
            if [ "$(echo ${{ parameters.createIssue }} | tr '[:upper:]' '[:lower:]')" = "true" ]; then
              rules="MissingGenericsValidation"
            fi
            ;;
        esac

        echo "Selected rules: $rules"
        echo "##vso[task.setvariable variable=SelectedRules]$rules"

        echo "Selected test case: $runTestCase"
        echo "##vso[task.setvariable variable=RunTestCase]$runTestCase"
      name: setRules

    - template: ../common/content-validation-for-java.yml
      parameters:
        packageName: $(PackageName)
        rules: $(SelectedRules)
        runTestCase: $(RunTestCase)

## Need to confirm, disabled for now
# - stage: TotalIssuesSummary
#   condition: always()
#   jobs:
#   - job: Maintain_Total_Issues_List
#     displayName: Maintain_Total_Issues_List
#     pool:
#       vmImage: ubuntu-latest
#     steps:
#     - task: DownloadPipelineArtifact@2
#       displayName: Download The Last Artifact history-issues-summary
#       inputs:
#         buildType: 'specific'
#         project: '$(System.TeamProject)'
#         pipeline: '$(System.DefinitionName)'
#         buildVersionToDownload: 'latestFromBranch'
#         allowPartiallySucceededBuilds: true
#         allowFailedBuilds: true
#         branchName: 'refs/heads/main'
#         artifactName: 'issues-summary'
#         downloadPath: '$(System.DefaultWorkingDirectory)/Artifacts'
#       continueOnError: true

#     - task: DownloadPipelineArtifact@2
#       displayName: Download The Current Artifact 
#       inputs:
#         buildType: 'current'
#         downloadPath: '$(System.DefaultWorkingDirectory)/Artifacts'

#     - task: DotNetCoreCLI@2
#       displayName: Build issuer helper project
#       inputs:
#         command: 'build'
#         projects: 'IssuerHelper/IssuerHelper.csproj'

#     - script: |
#         organization=$(System.CollectionUri)
#         project=$(System.TeamProject)
#         buildId=$(Build.BuildId)
  
#         pipelineUrl="${organization}${project}/_build/results?buildId=${buildId}"
  
#         echo "##vso[task.setvariable variable=pipelineUrl;]$pipelineUrl"
#       displayName: Get the current pipeline url

#     - task: DotNetCoreCLI@2
#       displayName: Summary Total Issues of all packages
#       env:
#         PackageName: ${{ parameters.packages }}
#         PipelineRunLink: $(pipelineUrl)
#         GitHubPat: $(GITHUB_PAT)
#         Language: 'Java'
#         GitHubOwner: $(GITHUB_OWNER)
#         GitHubRepo: $(GITHUB_REPO)
#       inputs:
#         command: 'run'
#         workingDirectory: '$(System.DefaultWorkingDirectory)/IssuerHelper'

#     - task: PublishPipelineArtifact@1
#       displayName: "Upload pipeline test data"
#       inputs:
#         targetPath: $(System.DefaultWorkingDirectory)/Reports
#         artifactName: issues-summary
#         publishLocation: "pipeline"

#     - task: Bash@3
#       displayName: 'Set Script Executable'
#       inputs:
#         targetType: 'inline'
#         script: |
#           chmod +x $(System.DefaultWorkingDirectory)/eng/scripts/push-pipeline-result-markdown.sh

#     - task: Bash@3
#       displayName: 'Push commit about current pipeline status'
#       inputs:
#         targetType: 'filePath'
#         filePath: '$(System.DefaultWorkingDirectory)/eng/scripts/push-pipeline-result-markdown.sh'
#         arguments: >-
#           $(GITHUB_PAT)
#           $(GITHUB_OWNER)
#           $(GITHUB_REPO)
#           $(GIT_USER_NAME)
#           $(GIT_USER_EMAIL)
#           'Java'