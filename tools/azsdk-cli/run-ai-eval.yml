parameters:
  EvalProject: ''
  OpenAIEndPoint: $(azsdk-eval-openai-url)
  Model: 'gpt-5'
  RepoName: 'azure-rest-api-specs'
  RepoOwner: 'Azure'
  RepoCommit: 'main'
  WorkingDirectory: $(System.DefaultWorkingDirectory)

jobs:
  - job: Run_Eval
    displayName: 'Run AI Eval'
    pool:
      name: $(LINUXPOOL)
      image: $(LINUXVMIMAGE)
      os: linux

    steps:
    - checkout: self
    - template: /eng/pipelines/templates/steps/install-dotnet.yml
    - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
      parameters:
        SkipCheckoutNone: true
        Repositories:
          - Name: ${{ parameters.RepoOwner }}/${{ parameters.RepoName }}
            Commitish: ${{ parameters.RepoCommit }}
            WorkingDirectory: $(System.DefaultWorkingDirectory)/${{ parameters.RepoName }}
        Paths:
          - '.github'
          - '.vscode/**'
          - 'eng/common/**'

    - task: AzureCLI@2
      displayName: 'Run eval'
      condition: and(succeeded(), ne(variables['Skip.Eval'], 'true'))
      inputs:
        azureSubscription: opensource-api-connection
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        workingDirectory: '${{ parameters.EvalProject }}'
        inlineScript: |
          echo "Logged in to Azure"
          echo "Running eval in project ${{ parameters.EvalProject }}"
          echo "=== Checking eng/common directory ==="
          echo "Does eng/common directory exist?"
          ls -la "$(System.DefaultWorkingDirectory)/azure-rest-api-specs/eng/" || echo "eng directory not found"
          ls -la "$(System.DefaultWorkingDirectory)/azure-rest-api-specs/eng/common/" || echo "eng/common directory not found"
          echo "Looking for instruction files in eng/common:"
          find "$(System.DefaultWorkingDirectory)/azure-rest-api-specs/eng/common/" -name "*.md" -o -name "*instruction*" || echo "No instruction files found"
          echo "=== Checking eng/common/instructions specifically ==="
          ls -la "$(System.DefaultWorkingDirectory)/azure-rest-api-specs/eng/common/instructions/" || echo "instructions directory not found"
          echo "Checking for azsdk-tools subdirectory:"
          ls -la "$(System.DefaultWorkingDirectory)/azure-rest-api-specs/eng/common/instructions/azsdk-tools/" || echo "azsdk-tools directory not found"
          echo "Looking for the specific file:"
          ls -la "$(System.DefaultWorkingDirectory)/azure-rest-api-specs/eng/common/instructions/azsdk-tools/typespec-to-sdk.instructions.md" || echo "typespec-to-sdk.instructions.md not found"
          dotnet test /p:ArtifactsPackagesDir=$(Build.ArtifactStagingDirectory) $(Warn) --logger trx
      env:
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
        DOTNET_CLI_TELEMETRY_OPTOUT: 1
        DOTNET_MULTILEVEL_LOOKUP: 0
        AZURE_OPENAI_MODEL_DEPLOYMENT_NAME: ${{ parameters.Model }}
        AZURE_OPENAI_ENDPOINT: ${{ parameters.OpenAIEndPoint }}
        COPILOT_INSTRUCTIONS_REPOSITORY_NAME: ${{ parameters.RepoName }}
        COPILOT_INSTRUCTIONS_REPOSITORY_OWNER: ${{ parameters.RepoOwner }}
        COPILOT_INSTRUCTIONS_PATH: $(System.DefaultWorkingDirectory)/${{ parameters.RepoName }}/.github/copilot-instructions.md

    - task: PublishTestResults@2
      condition: succeededOrFailed()
      inputs:
        testResultsFiles: '**/*.trx'
        testRunTitle: $(System.JobDisplayName)
        testResultsFormat: 'VSTest'
        mergeTestResults: true