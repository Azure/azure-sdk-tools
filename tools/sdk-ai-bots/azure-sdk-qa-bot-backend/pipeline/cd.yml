name: Deploy Azure SDK QA Bot Backend

trigger: none
pr: none

parameters:
  - name: environment
    displayName: 'Target Environment'
    type: string
    default: dev
    values:
      - dev
      - preview
      - prod
  - name: slot
    displayName: 'Target Slot'
    type: string
    default: default
    values:
      - default
      - authoring

variables:
  - template: /eng/pipelines/templates/variables/globals.yml
  - template: /eng/pipelines/templates/variables/image.yml
  - ${{ if eq(parameters.environment, 'dev') }}:
    - group: 'Azure SDK QA Bot Dev Variables'
  - ${{ if eq(parameters.environment, 'preview') }}:
    - group: 'Azure SDK QA Bot Preview Variables'
  - ${{ if eq(parameters.environment, 'prod') }}:
    - group: 'Azure SDK QA Bot Prod Variables'
  - name: imageName
    value: 'azure-sdk-qa-bot-backend'
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)/tools/sdk-ai-bots/azure-sdk-qa-bot-backend'
extends:
  template: /eng/pipelines/templates/stages/1es-redirect.yml
  parameters:
    Use1ESOfficial: true
    stages:
      - stage: DeployPipeline
        displayName: 'Deploy Pipeline'
        jobs:
          - job: RunDeploy
            displayName: 'Run Deploy Flow'
            pool:
              name: $(LINUXPOOL)
              image: $(LINUXVMIMAGE)
              os: linux
            steps:
              # 1. Checkout
              - checkout: self
                displayName: 'Checkout repository'
                persistCredentials: true
                continueOnError: false

              # 2. Resolve image tag
              - bash: |
                  set -euo pipefail
                  if [ "${{ parameters.environment }}" = "dev" ]; then
                    IMAGE_TAG=$(git rev-parse --short HEAD)
                  else
                    VERSION_FILE="$(System.DefaultWorkingDirectory)/tools/sdk-ai-bots/azure-sdk-qa-bot-backend/version.go"
                    [ -f "$VERSION_FILE" ] || { echo "version.go missing" >&2; exit 1; }
                    MODULE_VERSION=$(grep -m1 moduleVersion "$VERSION_FILE" | sed -n 's/.*moduleVersion.*"\(.*\)".*/\1/p')
                    [ -n "$MODULE_VERSION" ] || { echo "Failed to determine module version" >&2; exit 1; }
                    COMMIT_ID=$(git rev-parse --short HEAD)
                    [ -n "$COMMIT_ID" ] || { echo "Failed to determine commit id" >&2; exit 1; }
                    IMAGE_TAG="${MODULE_VERSION}_${COMMIT_ID}"
                  fi
                  echo "##vso[task.setvariable variable=imageTag]$IMAGE_TAG"
                  echo "Resolved image tag: $IMAGE_TAG"
                displayName: 'Resolve Image Tag'
                failOnStderr: true
                continueOnError: false

              # 3. Build & push (prod reuse existing image)
              - task: AzureCLI@2
                condition: ne('${{ parameters.environment }}','prod')
                displayName: 'Build & Push Image'
                continueOnError: false
                inputs:
                  azureSubscription: $(SERVICE_CONNECTION)
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    set -euo pipefail
                    ACR_LOGIN_SERVER=$(az acr show --name "$(ACR_NAME)" --resource-group "$(ACR_RESOURCE_GROUP)" --query loginServer -o tsv)
                    echo "ACR: $ACR_LOGIN_SERVER"
                    az acr login --name "$(ACR_NAME)"
                    docker build -t "$(imageName):$(imageTag)" -f "$(workingDirectory)/Dockerfile" "$(System.DefaultWorkingDirectory)"
                    docker tag "$(imageName):$(imageTag)" "$ACR_LOGIN_SERVER/$(imageName):$(imageTag)"
                    docker push "$ACR_LOGIN_SERVER/$(imageName):$(imageTag)"
                    echo "Image pushed: $ACR_LOGIN_SERVER/$(imageName):$(imageTag)"

              # 4. Validate image exists
              - task: AzureCLI@2
                displayName: 'Validate Image Exists'
                continueOnError: false
                inputs:
                  azureSubscription: $(SERVICE_CONNECTION)
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    set -euo pipefail
                    echo "Validating image $(imageName):$(imageTag) in ACR $(ACR_NAME)"
                    if az acr repository show-tags --name "$(ACR_NAME)" --repository "$(imageName)" --output tsv | grep -Fxq "$(imageTag)"; then
                      echo "Image found"
                    else
                      echo "Image $(imageName):$(imageTag) not found in $(ACR_NAME)" >&2
                      if [ "${{ parameters.environment }}" = "prod" ]; then
                        echo "You should make sure the current version is already deployed to the preview environment before release to production." >&2
                      fi
                      exit 1
                    fi

              # 5. Deploy App Service
              - task: AzureCLI@2
                displayName: 'Update App Service'
                continueOnError: false
                inputs:
                  azureSubscription: $(SERVICE_CONNECTION)
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    set -euo pipefail
                    SLOT="${{ parameters.slot }}"
                    if [ -n "$SLOT" ] && [ "$SLOT" != "default" ]; then
                      TARGET="$(APP_NAME)/$SLOT"
                      SLOT_ARG="--slot $SLOT"
                    else
                      TARGET="$(APP_NAME)"
                      SLOT_ARG=""
                    fi
                    echo "Updating container image $(imageName):$(imageTag) for app $TARGET"
                    ACR_LOGIN_SERVER=$(az acr show --name "$(ACR_NAME)" --resource-group "$(ACR_RESOURCE_GROUP)" --query loginServer -o tsv)
                    echo "ACR: $ACR_LOGIN_SERVER"
                    set +e
                    OUTPUT=$(az webapp config container set \
                      --name "$(APP_NAME)" \
                      --resource-group "$(RESOURCE_GROUP)" \
                      $SLOT_ARG \
                      --container-image-name "$ACR_LOGIN_SERVER/$(imageName):$(imageTag)" \
                      --container-registry-url "https://$ACR_LOGIN_SERVER" 2>&1)
                    STATUS=$?
                    set -euo pipefail
                    echo "$OUTPUT"
                    [ $STATUS -eq 0 ] || { echo "Failed to update container" >&2; exit $STATUS; }
                    echo "Container configuration updated"
                    az webapp restart --name "$(APP_NAME)" --resource-group "$(RESOURCE_GROUP)" $SLOT_ARG
                    echo "Webapp restart requested"
                env:
                  APP_NAME: $(APP_NAME)
                  RESOURCE_GROUP: $(RESOURCE_GROUP)
                  ACR_NAME: $(ACR_NAME)
                  ACR_RESOURCE_GROUP: $(ACR_RESOURCE_GROUP)
                  IMAGE_NAME: $(imageName)

              # 6. Health check
              - task: AzureCLI@2
                displayName: 'Health Check'
                continueOnError: false
                inputs:
                  azureSubscription: $(SERVICE_CONNECTION)
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    set -euo pipefail
                    SLOT="${{ parameters.slot }}"
                    if [ -n "$SLOT" ] && [ "$SLOT" != "default" ]; then
                      TARGET="$(APP_NAME)/$SLOT"
                      SLOT_ARG="--slot $SLOT"
                    else
                      TARGET="$(APP_NAME)"
                      SLOT_ARG=""
                    fi
                    APP_URL=$(az webapp show --name "$(APP_NAME)" --resource-group "$(RESOURCE_GROUP)" $SLOT_ARG --query defaultHostName -o tsv)
                    echo "App URL: https://$APP_URL"
                    echo "Waiting for health..."; sleep 25
                    HTTP_STATUS=$(curl -s -o /dev/null -w '%{http_code}' https://$APP_URL/ping || echo 000)
                    if [ "$HTTP_STATUS" = "200" ]; then
                      echo "Health check OK"
                    else
                      echo "Health endpoint returned $HTTP_STATUS" >&2
                    fi
                    ACR_LOGIN_SERVER=$(az acr show --name "$(ACR_NAME)" --resource-group "$(ACR_RESOURCE_GROUP)" --query loginServer -o tsv)
                    echo "=== Deployment Summary ==="
                    echo "Environment: ${{ parameters.environment }}"
                    echo "Slot: ${{ parameters.slot }}"
                    echo "Image Tag: $(imageTag)"
                    echo "Resource Group: $(RESOURCE_GROUP)"
                    echo "App Service: $TARGET"
                    echo "Image: $ACR_LOGIN_SERVER/$(imageName):$(imageTag)"
                    echo "Health Status: $HTTP_STATUS"
                    echo "URL: https://$APP_URL"
                    echo "=========================="
                env:
                  APP_NAME: $(APP_NAME)
                  RESOURCE_GROUP: $(RESOURCE_GROUP)
                  ACR_NAME: $(ACR_NAME)
                  ACR_RESOURCE_GROUP: $(ACR_RESOURCE_GROUP)
                  IMAGE_NAME: $(imageName)
