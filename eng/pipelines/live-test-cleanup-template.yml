parameters:
  - name: DryRun
    type: boolean
    default: false
  - name: DisplayName
    type: string
  - name: SubscriptionConfigurations
    type: object
    default:
      - $(sub-config-azure-cloud-test-resources)
  - name: GithubAliasCachePath
    type: string
  - name: AdditionalParameters
    type: string
    default: ""

steps:
  - template: /eng/common/TestResources/build-test-resource-config.yml
    parameters:
      SubscriptionConfigurations: ${{ parameters.SubscriptionConfigurations }}

  - task: AzureCLI@2
    displayName: Authenticate to OpenSource API
    inputs:
      azureSubscription: opensource-api-connection
      scriptType: pscore
      scriptLocation: inlineScript
      inlineScript: |
        $jwt_accessToken = az account get-access-token --scope 2789159d-8d8b-4d13-b90b-ca29c1707afd/.default --query "accessToken" --output tsv
        Write-Host "##vso[task.setvariable variable=opensource-api-token;isSecret=true]$jwt_accessToken"

  - pwsh: |
      eng/common/scripts/Import-AzModules.ps1
      Import-Module Az.Accounts

      $subscriptionConfiguration = @'
        $(SubscriptionConfiguration)
      '@ | ConvertFrom-Json -AsHashtable

      ./eng/scripts/live-test-resource-cleanup.ps1 `
        -OpensourceApiApplicationToken $(opensource-api-token) `
        -GithubAliasCachePath ${{ parameters.GithubAliasCachePath }} `
        @subscriptionConfiguration `
        -Verbose `
        ${{ parameters.AdditionalParameters }} `
        -WhatIf:$${{ parameters.DryRun }}
    displayName: ${{ parameters.DisplayName }}
    continueOnError: true

