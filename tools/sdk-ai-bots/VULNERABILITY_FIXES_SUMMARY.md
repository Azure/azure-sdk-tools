# Security Vulnerability Fixes Summary

This document summarizes the security vulnerabilities that have been addressed in the Azure SDK AI Bots project.

## Overview

Date: October 21, 2025  
Scope: All packages under `tools/sdk-ai-bots/`

## Vulnerabilities Fixed

### Critical & High Severity Issues: 2 Fixed

#### 1. SheetJS Prototype Pollution (GHSA-4r6h-8v6p-xvw6)
- **Severity**: High (CVSS 7.8)
- **Package**: `azure-sdk-qa-bot-function`
- **Original Version**: `xlsx@0.18.5`
- **Fix**: Migrated to `@e965/xlsx@0.20.3` (community fork with security patches)
- **Status**: ✅ Fixed

#### 2. SheetJS ReDoS (GHSA-5pgg-2g8v-p4x9)
- **Severity**: High (CVSS 7.5)
- **Package**: `azure-sdk-qa-bot-function`
- **Original Version**: `xlsx@0.18.5`
- **Fix**: Migrated to `@e965/xlsx@0.20.3`
- **Status**: ✅ Fixed

### Moderate Severity Issues: 4 Fixed

#### 3. Vite Path Traversal (GHSA-93m4-6634-74q7)
- **Severity**: Moderate
- **Affected Packages**: 
  - `azure-sdk-qa-bot@1.0.0`
  - `azure-sdk-qa-bot-backend-shared@1.0.0`
  - `azure-sdk-qa-bot-knowledge-sync@1.0.0`
- **Fix**: Updated vite to patched version via `npm audit fix`
- **Status**: ✅ Fixed

#### 4. Zod DoS (GHSA-m95q-7qp3-xv42)
- **Severity**: Moderate
- **Package**: `azure-sdk-qa-bot-function`
- **Fix**: Updated dependencies to get patched zod version
- **Status**: ✅ Fixed

#### 5. Timing Attack in API Key Authentication
- **Severity**: Moderate (Custom Finding)
- **Package**: `azure-sdk-qa-bot-backend-shared`
- **File**: `src/auth/key-auth.ts`
- **Issue**: String comparison vulnerable to timing attacks
- **Fix**: Implemented `crypto.timingSafeEqual()` for constant-time comparison
- **Status**: ✅ Fixed

#### 6. SSRF via User-Controlled URLs
- **Severity**: Moderate (Custom Finding)
- **Package**: `azure-sdk-qa-bot-backend-shared`
- **Files**: 
  - `src/input/ImageContentExtractor.ts`
  - `src/routes/prompts.ts`
- **Issue**: User-controlled URLs could be used to access internal resources
- **Fix**: Added validation to:
  - Restrict to HTTPS only
  - Block private IP ranges (10.x, 172.16-31.x, 192.168.x)
  - Block localhost and link-local addresses
- **Status**: ✅ Fixed

## Remaining Known Issues

### lodash.trimend ReDoS (GHSA-29mw-wpgm-hmr9)
- **Severity**: Moderate (CVSS 5.3)
- **Package**: `azure-sdk-qa-bot`
- **Status**: ⚠️ Awaiting upstream fix
- **Details**: 
  - Transitive dependency from `@microsoft/teams-ai@1.7.4`
  - Already at latest version of teams-ai library
  - All intermediate packages are at their latest versions
  - No patched version of `lodash.trimend` exists (deprecated package)
  - Risk is LOW due to input constraints from Teams platform and added validations
- **Mitigation**: 
  - Updated to latest version of `@microsoft/teams-ai` (1.7.4)
  - Input validation added
  - Teams platform provides rate limiting and input length restrictions
  - Monitoring for upstream fixes from Microsoft

## Additional Security Improvements

1. **Updated Dependencies**:
   - `@microsoft/teams-ai`: 1.5.3 → 1.7.4

2. **Code Quality**:
   - All TypeScript builds pass successfully
   - All existing tests pass
   - CodeQL scan shows 0 alerts

3. **Documentation**:
   - Created `SECURITY_NOTES.md` with detailed security documentation
   - Documented mitigation strategies for known issues

## Testing

All packages have been built and tested:
- ✅ `azure-sdk-qa-bot`: Build successful
- ✅ `azure-sdk-qa-bot-backend-shared`: Build successful  
- ✅ `azure-sdk-qa-bot-function`: Build successful
- ✅ `azure-sdk-qa-bot-knowledge-sync`: Build successful, 13 tests passing

## npm audit Results

### After Fixes:
- `azure-sdk-qa-bot`: 7 moderate (all lodash.trimend, transitive)
- `azure-sdk-qa-bot-backend-shared`: 0 vulnerabilities ✅
- `azure-sdk-qa-bot-function`: 0 vulnerabilities ✅
- `azure-sdk-qa-bot-knowledge-sync`: 0 vulnerabilities ✅

## Recommendations

1. Monitor `@microsoft/teams-ai` for updates that may fix the lodash.trimend issue
2. Consider opening an issue with Microsoft about the deprecated dependency
3. Run `npm audit` regularly as part of CI/CD pipeline
4. Review security advisories monthly
5. Keep dependencies up to date

## References

- [GHSA-29mw-wpgm-hmr9](https://github.com/advisories/GHSA-29mw-wpgm-hmr9) - lodash.trimend ReDoS
- [GHSA-93m4-6634-74q7](https://github.com/advisories/GHSA-93m4-6634-74q7) - Vite path traversal
- [GHSA-4r6h-8v6p-xvw6](https://github.com/advisories/GHSA-4r6h-8v6p-xvw6) - SheetJS prototype pollution
- [GHSA-5pgg-2g8v-p4x9](https://github.com/advisories/GHSA-5pgg-2g8v-p4x9) - SheetJS ReDoS
- [GHSA-m95q-7qp3-xv42](https://github.com/advisories/GHSA-m95q-7qp3-xv42) - Zod DoS
