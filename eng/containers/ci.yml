parameters:
- name: DockerDeployments
  type: object
  default:
  - name: test-proxy
    dockerRepo: 'engsys/ubuntu_testproxy_server'
    dockerFile: 'tools/test-proxy/docker/dockerfile'

trigger:
  branches:
    include:
    - master
    - main
  paths:
    include:
    - eng/containers/
    - tools/test-proxy/dockerfile

pr: none

pool:
  vmImage: 'ubuntu-18.04'

variables:
  - name: containerRegistry
    value: 'azsdkengsys'
  - name: imageTag
    value: $(build.buildid)
  - template: ../pipelines/templates/variables/globals.yml
  
steps:
- ${{ each config in parameters.DockerDeployments }}:
  - task: Docker@2
    displayName: Build ${{ config.name }} Docker Image
    inputs:
      command: build
      Dockerfile: ${{ config.dockerFile }}
      tags: $(imageTag)
      arguments: '-t $(containerRegistry).azurecr.io/${{ config.dockerRepo }}:$(imageTag)'
  - task: Docker@2
    displayName: Push ${{ config.name }} Docker Image
    inputs:
      containerRegistry: $(containerRegistry)
      repository: ${{ config.dockerRepo }}
      command: push
      tags: $(imageTag)