# This step is used to prevent duplication of artifact publishes when there is an issue that would prevent the overall success of the job.
# Ensuring that we only publish when successful (and two a differently named artifact otherwise) will allow easy retry on a build pipeline
# without running into the "cannot override artifact" failure when we finally do get a passing run.

# ArtifactName - The name of the artifact in the "successful" case.
# ArtifactPath - The path we will be publishing.
# CustomCondition - Used if there is additional logic necessary to prevent attempt of publish.

parameters:
  ArtifactName: ''
  ArtifactPath: ''
  CustomCondition: true
  PublishType: 'pipeline'
  DisplayName: ''

steps:
  - ${{ if eq(PublishType, 'pipeline') }}:
    - ${{if eq(variables['System.TeamProject'], 'internal')}}:
      - task: 1ES.PublishPipelineArtifact@1
        condition: and(succeeded(), ${{ parameters.CustomCondition }})
        displayName: ${{ coalesce(parameters.DisplayName, 'Publish parameters.ArtifactName Artifacts') }}
        inputs:
          artifact: '${{ parameters.ArtifactName }}'
          path: '${{ parameters.ArtifactPath }}'

      - task: 1ES.PublishPipelineArtifact@1
        condition: and(failed(), ${{ parameters.CustomCondition }})
        displayName: ${{ coalesce(parameters.DisplayName, 'Publish parameters.ArtifactName Artifacts') }} - Failed
        inputs:
          artifact: '${{ parameters.ArtifactName }}-FailedAttempt$(System.JobAttempt)'
          path: '${{ parameters.ArtifactPath }}'
    - ${{ else }}:
      - task: PublishPipelineArtifact@1
        condition: and(succeeded(), ${{ parameters.CustomCondition }})
        displayName: ${{ coalesce(parameters.DisplayName, 'Publish parameters.ArtifactName Artifacts') }}
        inputs:
          artifactName: '${{ parameters.ArtifactName }}'
          path: '${{ parameters.ArtifactPath }}'

      - task: PublishPipelineArtifact@1
        condition: and(failed(), ${{ parameters.CustomCondition }})
        displayName: ${{ coalesce(parameters.DisplayName, 'Publish parameters.ArtifactName Artifacts') }} - Failed
        inputs:
          artifactName: '${{ parameters.ArtifactName }}-FailedAttempt$(System.JobAttempt)'
          path: '${{ parameters.ArtifactPath }}'

  - ${{ if eq(PublishType, 'build') }}:
    - ${{if eq(variables['System.TeamProject'], 'internal')}}:
      - task: 1ES.PublishBuildArtifact@1
        condition: and(succeeded(), ${{ parameters.CustomCondition }})
        displayName: ${{ coalesce(parameters.DisplayName, 'Publish parameters.ArtifactName Artifacts') }}
        inputs:
          artifact: '${{ parameters.ArtifactName }}'
          path: '${{ parameters.ArtifactPath }}'

      - task: 1ES.PublishBuildArtifact@1
        condition: and(failed(), ${{ parameters.CustomCondition }})
        displayName: ${{ coalesce(parameters.DisplayName, 'Publish parameters.ArtifactName Artifacts') }} - Failed
        inputs:
          artifact: '${{ parameters.ArtifactName }}-FailedAttempt$(System.JobAttempt)'
          path: '${{ parameters.ArtifactPath }}'
    - ${{ else }}:
      - task: 1ES.PublishBuildArtifact@1
        condition: and(succeeded(), ${{ parameters.CustomCondition }})
        displayName: ${{ coalesce(parameters.DisplayName, 'Publish parameters.ArtifactName Artifacts') }}
        inputs:
          artifactName: '${{ parameters.ArtifactName }}'
          pathtoPublish: '${{ parameters.ArtifactPath }}'

      - task: 1ES.PublishBuildArtifact@1
        condition: and(failed(), ${{ parameters.CustomCondition }})
        displayName: ${{ coalesce(parameters.DisplayName, 'Publish parameters.ArtifactName Artifacts') }} - Failed
        inputs:
          artifactName: '${{ parameters.ArtifactName }}-FailedAttempt$(System.JobAttempt)'
          pathtoPublish: '${{ parameters.ArtifactPath }}'

  - ${{ if eq(PublishType, 'nuget') }}:
    - ${{if eq(variables['System.TeamProject'], 'internal')}}:
    - ${{ else }}:
