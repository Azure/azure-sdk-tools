# Assumes steps in deploy-test-resources.yml was run previously. Requires
# environment variable: AZURE_RESOURCEGROUP_NAME and Az PowerShell module

parameters:
  ServiceDirectory: ''
  SubscriptionConfiguration: sub-config-azure-cloud-test-resources

steps:
  # On MacOS there are problems with access to the ~/.Azure folder. This
  # workaround fixes the problem.
  - bash: sudo rm -rf ~/.Azure
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))
    displayName: Clean out ~/.Azure

  - pwsh: >
      eng/common/TestResources/Remove-TestResources.ps1
      -ResourceGroupName "${env:AZURE_RESOURCEGROUP_NAME}"
      -ServiceDirectory '${{ parameters.ServiceDirectory }}'
      -SubscriptionConfiguration ${{ parameters.SubscriptionConfiguration }}
      -KeyVaultName $(provisioner-keyvault-name)
      -KeyVaultTenantId $(provisioner-aad-tenant)
      -KeyVaultAppId $(provisioner-aad-id)
      -KeyVaultAppSecret $(provisioner-aad-secret)
      -Force
      -Verbose
    displayName: Remove test resources
    continueOnError: true