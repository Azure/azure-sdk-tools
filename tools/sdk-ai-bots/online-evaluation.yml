pool:
  vmImage: 'ubuntu-latest'

trigger: none

stages:
  - stage: 'evaluation'
    jobs:
      - job: 'evaluation'
        displayName: 'online evaluation'
        steps:
          - template: /eng/pipelines/templates/steps/use-python-version.yml
            parameters:
              versionSpec: '${{ parameters.PythonVersion }}'
          - script: |
              python --version
            displayName: 'check python'
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'azure-chat-bot-test'
              addSpnToEnvironment: true
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "##vso[task.setvariable variable=AZURE_CLIENT_ID]$servicePrincipalId"
                echo "##vso[task.setvariable variable=AZURE_TENANT_ID]$tenantId"
                echo "##vso[task.setvariable variable=AZURE_SUBSCRIPTION_ID]$(az account show --query id -o tsv)"
                echo "$idToken" > "$(Agent.BuildDirectory)/id_token"
                echo "##vso[task.setvariable variable=AZURE_FEDERATED_TOKEN_FILE]$(Agent.BuildDirectory)/id_token"
                echo "##vso[task.setvariable variable=SYSTEM_ACCESSTOKEN]$idToken"
          - script: |
              python download-md-dataset.py
              python convert-md-to-jsonl.py --source_md_path "$(Build.SourcesDirectory)/tools/sdk-ai-bots/azure-sdk-qa-bot-evaluation/online-qa-tests" --dest_jsonl_folder "$(Build.SourcesDirectory)/tools/sdk-ai-bots/azure-sdk-qa-bot-evaluation/online-tests"
              python run.py --evaluation_name_prefix $(Build.BuildId) --test_folder "$(Build.SourcesDirectory)/tools/sdk-ai-bots/azure-sdk-qa-bot-evaluation/online-tests"
            displayName: 'Run Evals'
            workingDirectory: $(Build.SourcesDirectory)/tools/sdk-ai-bots/azure-sdk-qa-bot-evaluation
            env:
              AZURE_AI_PROJECT_ENDPOINT: $(AZURE_AI_PROJECT_ENDPOINT)
              AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
              AZURE_CLIENT_ID: $(AZURE_CLIENT_ID)
              AZURE_TENANT_ID: $(AZURE_TENANT_ID)
              AZURE_FEDERATED_TOKEN_FILE: $(AZURE_FEDERATED_TOKEN_FILE)
              AZURE_FOUNDRY_RESOURCE_GROUP: $(AZURE_FOUNDRY_RESOURCE_GROUP)
              AZURE_FOUNDRY_PROJECT_NAME: $(AZURE_FOUNDRY_PROJECT_NAME)
              BOT_AGENT_API_KEY: $(BOT_AGENT_API_KEY)
              AZURE_OPENAI_ENDPOINT: $(AZURE_OPENAI_ENDPOINT)
              AZURE_OPENAI_API_KEY: $(AZURE_OPENAI_API_KEY)
              AZURE_COMPLETION_MODEL_NAME: $(AZURE_COMPLETION_MODEL_NAME)
              AZURE_EVALUATION_MODEL_NAME: $(AZURE_EVALUATION_MODEL_NAME)
              AZURE_API_VERSION: $(AZURE_API_VERSION)
              BOT_SERVICE_ENDPOINT: $(BOT_SERVICE_ENDPOINT)
              STORAGE_BLOB_ACCOUNT: $(STORAGE_BLOB_ACCOUNT)
              AI_ONLINE_PERFORMANCE_EVALUATION_STORAGE_CONTAINER: $(AI_ONLINE_PERFORMANCE_EVALUATION_STORAGE_CONTAINER)
              BOT_CONFIG_CONTAINER: $(BOT_CONFIG_CONTAINER)
              BOT_CONFIG_CHANNEL_BLOB: $(BOT_CONFIG_CHANNEL_BLOB)
