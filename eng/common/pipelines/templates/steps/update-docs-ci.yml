# intended to be used as part of a release process
parameters:
  ArtifactLocation: 'not-specified'
  PackageRepository: 'not-specified'
  ReleaseSha: 'not-specified'
  RepoId: 'not-specified'
  WorkingDirectory: ''
  ScriptDirectory: eng/common/scripts
  TargetDocRepoName: ''
  TargetDocRepoOwner: ''
  PRBranchName: ''
  SourceBranchName: 'smoke-test'
  ArtifactName: ''

  # for java we need to pass additional args. these will be passed to monikerId
  PreviewConfigLoc: ''
  PreviewConfigArgs: ''
  LatestConfigLoc: ''
  LatestConfigArgs: ''

  # externally set, as eng-common does not have the identity-resolver. Run as pre-step
  GHReviewersVariable: '' 
  GHTeamReviewersVariable: '' 

steps:
- pwsh: |
    git clone https://github.com/${{ parameters.TargetDocRepoOwner }}/${{ parameters.TargetDocRepoName }} ${{ parameters.WorkingDirectory }}/repo

    try {
      Push-Location ${{ parameters.WorkingDirectory }}/repo

      Write-Host "git checkout ${{ parameters.SourceBranchName }}"
      git checkout ${{ parameters.SourceBranchName }}
    } finally {
      Pop-Location
    }
  displayName: Clone Target Documentation Repository

- task: PowerShell@2
  displayName: 'Update Targeted GA Packages'
  inputs:
    targetType: filePath
    filePath: ${{ parameters.ScriptDirectory }}/update-docs-ci.ps1
    arguments: >
      -ArtifactLocation ${{ parameters.ArtifactLocation }}
      -WorkDirectory "${{ parameters.WorkingDirectory }}"
      -RepoId ${{ parameters.RepoId }}
      -Repository ${{ parameters.PackageRepository }}
      -ReleaseSHA ${{ parameters.ReleaseSha }}
      -CIRepository "${{ parameters.WorkingDirectory }}/repo"
      -PathToConfigFile ${{ parameters.LatestConfigLoc }}
      -Mode Latest
      ${{ parameters.LatestConfigArgs }}
    pwsh: true
  env:
    GH_TOKEN: $(azuresdk-github-pat)

- task: PowerShell@2
  displayName: 'Update Targeted Preview Packages'
  inputs:
    targetType: filePath
    filePath: ${{ parameters.ScriptDirectory }}/update-docs-ci.ps1
    arguments: >
      -ArtifactLocation ${{ parameters.ArtifactLocation }}
      -WorkDirectory "${{ parameters.WorkingDirectory }}"
      -RepoId ${{ parameters.RepoId }}
      -Repository ${{ parameters.PackageRepository }}
      -ReleaseSHA ${{ parameters.ReleaseSha }}
      -CIRepository "${{ parameters.WorkingDirectory }}/repo"
      -PathToConfigFile ${{ parameters.PreviewConfigArgs }}
      -Mode Preview
      ${{ parameters.PreviewConfigArgs }}
    pwsh: true
  env:
    GH_TOKEN: $(azuresdk-github-pat)

- template: /eng/common/pipelines/templates/steps/create-pull-request.yml
  parameters:
    RepoName: ${{ parameters.TargetDocRepoName }}
    RepoOwner: ${{ parameters.TargetDocRepoOwner }}
    PRBranchName: ${{ parameters.PRBranchName }}
    CommitMsg: "Update readme content for ${{ parameters.ArtifactName }}"
    PRTitle: "Docs.MS CI Update for ${{ parameters.ArtifactName }}"
    BaseBranchName: smoke-test
    WorkingDirectory: ${{ parameters.WorkingDirectory }}/repo
    ScriptDirectory: ${{ parameters.WorkingDirectory }}/${{ parameters.ScriptDirectory }}
    GHReviewersVariable: ${{ parameters.GHReviewersVariable }}
    GHTeamReviewersVariable: ${{ parameters.GHTeamReviewersVariable }} 