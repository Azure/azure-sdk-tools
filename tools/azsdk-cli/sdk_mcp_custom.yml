parameters:
  EvalProject: ''
  OpenAIEndPoint: 'https://ai-prmarottai3149546654251245.openai.azure.com/'
  Model: 'gpt-5'
  RepoName: 'azure-rest-api-specs'
  RepoOwner: 'Azure'
  RepoCommit: 'main'
  WorkingDirectory: $(System.DefaultWorkingDirectory)

jobs:
  - job: Run_Eval
    displayName: 'Run AI Eval'
    pool:
      name: $(LINUXPOOL)
      image: $(LINUXVMIMAGE)
      os: linux

    steps:
    - checkout: self
    - template: /eng/pipelines/templates/steps/install-dotnet.yml
    - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
      parameters:
        SkipCheckoutNone: true
        Repositories:
          - Name: ${{ parameters.RepoOwner }}/${{ parameters.RepoName }}
            Commitish: ${{ parameters.RepoCommit }}
            WorkingDirectory: $(System.DefaultWorkingDirectory)/${{ parameters.RepoName }}
        Paths:
          - '.github'
          - '.vscode/**'
          - 'eng/common/**'
    - task: AzureCLI@2
      displayName: 'Run eval'
      condition: and(succeeded(), ne(variables['Skip.Eval'], 'true'))
      inputs:
        azureSubscription: opensource-api-connection
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        workingDirectory: '${{ parameters.EvalProject }}'
        inlineScript: |
          echo "Logged in to Azure"
          echo "Running eval in project ${{ parameters.EvalProject }}"
          dotnet test /p:ArtifactsPackagesDir=$(Build.ArtifactStagingDirectory) $(Warn) --logger trx
      env:
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
        DOTNET_CLI_TELEMETRY_OPTOUT: 1
        DOTNET_MULTILEVEL_LOOKUP: 0
        AZURE_OPENAI_MODEL_DEPLOYMENT_NAME: ${{ parameters.Model }}
        AZURE_OPENAI_ENDPOINT: ${{ parameters.OpenAIEndPoint }}
        COPILOT_INSTRUCTIONS_REPOSITORY_NAME: ${{ parameters.RepoName }}
        COPILOT_INSTRUCTIONS_REPOSITORY_OWNER: ${{ parameters.RepoOwner }}
        COPILOT_INSTRUCTIONS_PATH: $(System.DefaultWorkingDirectory)/${{ parameters.RepoName }}/.github/copilot-instructions.md

    - task: PublishTestResults@2
      condition: succeededOrFailed()
      inputs:
        testResultsFiles: '**/*.trx'
        testRunTitle: $(System.JobDisplayName)
        testResultsFormat: 'VSTest'
        mergeTestResults: true
  
  - job: Update_MCP_List
    displayName: 'Update MCP List'
    condition: ne(variables['Build.Reason'],'PullRequest')
    pool:
      name: $(LINUXPOOL)
      image: $(LINUXVMIMAGE)
      os: linux
    
    steps:
    - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
      parameters:
        Repositories:
          - Name: Azure/azure-sdk-tools
            Commitish: $(Build.SourceVersion)
            WorkingDirectory: $(System.DefaultWorkingDirectory)/azure-sdk-tools-current
          - Name: Azure/azure-sdk-tools
            Commitish: main
            WorkingDirectory: $(System.DefaultWorkingDirectory)/azure-sdk-tools-main
        Paths:
          - '**'
    
    - template: /eng/pipelines/templates/steps/install-dotnet.yml
    
    - task: DotNetCoreCLI@2
      displayName: 'Build Azure SDK Tools CLI from current branch'
      inputs:
        command: 'build'
        projects: '$(System.DefaultWorkingDirectory)/azure-sdk-tools-current/tools/azsdk-cli/Azure.Sdk.Tools.Cli/Azure.Sdk.Tools.Cli.csproj'
        arguments: '--configuration Release'
    
    - task: PowerShell@2
      displayName: 'Get MCP Tools List and Update Documentation'
      inputs:
        targetType: 'filePath'
        filePath: '$(System.DefaultWorkingDirectory)/azure-sdk-tools-main/tools/azsdk-cli/update-mcp-tools-docs.ps1'
        arguments: >
          -AzsdkCliPath $(System.DefaultWorkingDirectory)/azure-sdk-tools-current/artifacts/bin/Azure.Sdk.Tools.Cli/Release/net8.0/azsdk
          -CsprojPath $(System.DefaultWorkingDirectory)/azure-sdk-tools-current/tools/azsdk-cli/Azure.Sdk.Tools.Cli/Azure.Sdk.Tools.Cli.csproj
        pwsh: true
        workingDirectory: '$(System.DefaultWorkingDirectory)/azure-sdk-tools-main'
    
    - template: /eng/common/pipelines/templates/steps/create-pull-request.yml
      parameters:
        RepoName: azure-sdk-tools
        BaseBranchName: main
        PRBranchName: update-mcp-tools-list-$(Build.BuildId)
        CommitMsg: "Update MCP tools list"
        PRTitle: "Update MCP tools list"
        WorkingDirectory: $(System.DefaultWorkingDirectory)/azure-sdk-tools-main
        ScriptDirectory: $(System.DefaultWorkingDirectory)/azure-sdk-tools-main/eng/common/scripts/