parameters:
  - name: ImageName
    type: string
  - name: ImageTag
    type: string
  - name: PrepareScript
    type: string
  - name: DockerFile
    type: string
  - name: AdditionalDockerBuildArgs
    type: string
    default: ''


steps:
  - ${{ if parameters.prepareScript }}:
    - pwsh: |
        ./${{ parameters.prepareScript }}
      displayName: "Run prep script"

  # we have an image name + tag combo (this is for images that will end up on our ACR)
  - ${{ if gt(length(parameters.ImageTag), 0) }}:
    - task: Docker@2
      displayName: Build ${{ parameters.ImageName }}:${{ parameters.ImageTag }}
      inputs:
        command: build
        Dockerfile: ${{ parameters.DockerFile }}
        tags: ${{ parameters.ImageTag }}
        arguments: '-t ${{ parameters.ImageName }}:${{ parameters.ImageTag }} ${{ parameters.AdditionalDockerBuildArgs }}'

  # we have an image name only (this is for images that will only ever exist locally)
  - ${{ if eq(length(parameters.ImageTag), 0) }}:
    - task: Docker@2
      displayName: Build ${{ parameters.ImageName }}:${{ parameters.ImageTag }}
      inputs:
        command: build
        Dockerfile: ${{ parameters.DockerFile }}
        arguments: '-t ${{ parameters.ImageName }} ${{ parameters.AdditionalDockerBuildArgs }}'
