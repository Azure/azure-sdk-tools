parameters:
  EvalProject: ''
  OpenAIEndPoint: $(azsdk-eval-openai-url)
  Model: 'gpt-5'
  RepoName: 'azure-rest-api-specs'
  RepoOwner: 'Azure'
  RepoCommit: 'main'
  WorkingDirectory: $(System.DefaultWorkingDirectory)

jobs:
  - job: Run_Eval
    displayName: 'Run AI Eval'
    pool:
      name: $(LINUXPOOL)
      image: $(LINUXVMIMAGE)
      os: linux

    steps:
    - checkout: self
    - template: /eng/pipelines/templates/steps/install-dotnet.yml
    - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
      parameters:
        SkipCheckoutNone: true
        Repositories:
          - Name: ${{ parameters.RepoOwner }}/${{ parameters.RepoName }}
            Commitish: ${{ parameters.RepoCommit }}
            WorkingDirectory: $(System.DefaultWorkingDirectory)/${{ parameters.RepoName }}
        Paths:
          - '.github/**/'
          - '.vscode/**/'
          - 'eng/common/**/'

    - task: AzureCLI@2
      displayName: 'Run eval'
      condition: and(succeeded(), ne(variables['Skip.Eval'], 'true'))
      inputs:
        azureSubscription: opensource-api-connection
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        workingDirectory: '${{ parameters.EvalProject }}'
        inlineScript: |
          echo "Logged in to Azure"
          echo "Running eval in project ${{ parameters.EvalProject }}"
          echo "Current working directory: $(pwd)"
          echo "Contents of current directory:"
          ls -la
          echo "Contents of parent directory:"
          ls -la ..
          echo "Looking for project file:"
          find . -name "*.csproj" -o -name "*.sln"
          echo "=== Checking .github directories ==="
          echo "System.DefaultWorkingDirectory contents:"
          ls -la "$(System.DefaultWorkingDirectory)"
          echo "Looking for .github directories:"
          find "$(System.DefaultWorkingDirectory)" -name ".github" -type d
          echo "Contents of azure-rest-api-specs .github directory:"
          ls -la "$(System.DefaultWorkingDirectory)/azure-rest-api-specs/.github/" || echo "Directory not found"
          echo "All files in azure-rest-api-specs .github:"
          find "$(System.DefaultWorkingDirectory)/azure-rest-api-specs/.github/" -type f || echo "No files found"
          echo "Checking COPILOT_INSTRUCTIONS_PATH:"
          echo "COPILOT_INSTRUCTIONS_PATH = $COPILOT_INSTRUCTIONS_PATH"
          if [ -f "$COPILOT_INSTRUCTIONS_PATH" ]; then
            echo "✓ Copilot instructions file exists"
          else
            echo "✗ Copilot instructions file NOT found"
            echo "Listing contents of $(dirname "$COPILOT_INSTRUCTIONS_PATH"):"
            ls -la "$(dirname "$COPILOT_INSTRUCTIONS_PATH")" || echo "Directory does not exist"
          fi
          dotnet test /p:ArtifactsPackagesDir=$(Build.ArtifactStagingDirectory) $(Warn) --logger trx
      env:
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
        DOTNET_CLI_TELEMETRY_OPTOUT: 1
        DOTNET_MULTILEVEL_LOOKUP: 0
        AZURE_OPENAI_MODEL_DEPLOYMENT_NAME: ${{ parameters.Model }}
        AZURE_OPENAI_ENDPOINT: ${{ parameters.OpenAIEndPoint }}
        COPILOT_INSTRUCTIONS_REPOSITORY_NAME: ${{ parameters.RepoName }}
        COPILOT_INSTRUCTIONS_REPOSITORY_OWNER: ${{ parameters.RepoOwner }}
        COPILOT_INSTRUCTIONS_PATH: $(System.DefaultWorkingDirectory)/${{ parameters.RepoName }}/.github/copilot-instructions.md

    - task: PublishTestResults@2
      condition: succeededOrFailed()
      inputs:
        testResultsFiles: '**/*.trx'
        testRunTitle: $(System.JobDisplayName)
        testResultsFormat: 'VSTest'
        mergeTestResults: true