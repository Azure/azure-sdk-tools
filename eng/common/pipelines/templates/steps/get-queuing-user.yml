parameters: 
  TargetVariable: ''

steps:
  # pull down identity-resolver here.
  - pwsh: |
      git clone https://github.com/Azure/azure-sdk-tools.git $(Build.SourcesDirectory)/tools_repo
      cd $(Build.SourcesDirectory)/tools_repo
      git checkout feature/identity-resolver
    displayName: Get Appropriate Build Tools

  - pwsh: |
      $result = dotnet run -v q -- `
        --aad-app-id-var APP_ID `
        --aad-app-secret-var APP_SECRET `
        --aad-tenant-var AAD_TENANT `
        --kusto-url-var KUSTO_URL `
        --kusto-database-var KUSTO_DB `
        --kusto-table-var KUSTO_TABLE `
        --identity "$(Build.QueuedBy)"
      $resolvedIdentity = $result[-1] | ConvertFrom-Json

      Write-Host $resolvedIdentity

      Write-Output "##vso[task.setvariable variable=${{ parameters.TargetVariable }}]$($resolvedIdentity.GithubUserName)"
    displayName: 'Run Identity Resolver'
    workingDirectory: $(Build.SourcesDirectory)/tools_repo/tools/notification-configuration/identity-resolver
    env:
      APP_ID: $(notification-aad-app-id)
      APP_SECRET: $(notification-aad-secret)
      AAD_TENANT: $(notification-aad-tenant)
      KUSTO_URL: $(notification-kusto-url)
      KUSTO_DB: $(notification-kusto-db)
      KUSTO_TABLE: $(notification-kusto-table)