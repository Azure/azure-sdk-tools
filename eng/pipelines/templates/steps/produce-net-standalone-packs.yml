parameters:
  - name: TargetDirectory
    type: string
  - name: StagingDirectory
    type: string
    default: $(Build.ArtifactStagingDirectory)
  - name: BuildMatrix
    type: object
    default: []

# A `BuildMatrix` is merely a list of possible targeted platforms. .NET 6+ can build for any target from any other target.
  # - rid: win-x64
  #   framework: net6.0
  # - rid: linux-x64
  #   framework: net6.0
  # - rid: osx-x64
  #   framework: net6.0

steps:
  - ${{ each target in parameters.BuildMatrix }}:
    - pwsh: |
        Write-Host "${{ and(not(startswith(target.rid, 'osx')), not(eq(variables['Agent.OS'], 'Darwin'))) }}"
        Write-Host "${{ and(startsWith(target.rid, 'osx'), eq(variables['Agent.OS'], 'Darwin')) }}"
        Write-Host "$(Agent.OS)"
        Write-Host "${{ target.rid }}"

        Write-Host "Breakdown of mac expressions is as follows"
        Write-Host "${{ startsWith(target.rid, 'osx') }}"
        Write-Host "${{ eq(variables['Agent.OS'], 'Darwin')) }}"
      displayName: Dump Expression Outputs

    # ensure that we only build the mac standalone executables on a mac agent, everything else on not mac
    - ${{ if and(startsWith(target.rid, 'osx'), eq(variables['Agent.OS'], 'Darwin')) }}:
      - task: Powershell@2
        inputs:
          workingDirectory: "$(Build.SourcesDirectory)"
          filePath: $(Build.SourcesDirectory)/eng/pipelines/templates/scripts/assemble-dotnet-standalone-exe.ps1
          arguments: >
            -Rid "${{ target.rid }}"
            -Target "${{ parameters.TargetDirectory }}"
            -ArtifactStagingDirectory "$(Build.ArtifactStagingDirectory)"
            -Framework "${{ target.framework }}"
          pwsh: true
        displayName: 'Produce Executable for ${{ target.rid }}'
        env:
          DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
          DOTNET_MULTILEVEL_LOOKUP: 0

      - template: /eng/common/pipelines/templates/steps/publish-artifact.yml
        parameters:
          ArtifactName: "standalone-${{ target.rid }}"
          ArtifactPath: "$(Build.ArtifactStagingDirectory)/${{ target.rid }}"

    - ${{ if and(not(startswith(target.rid, 'osx')), not(eq(variables['Agent.OS'], 'Darwin'))) }}:
      - task: Powershell@2
        inputs:
          workingDirectory: "$(Build.SourcesDirectory)"
          filePath: $(Build.SourcesDirectory)/eng/pipelines/templates/scripts/assemble-dotnet-standalone-exe.ps1
          arguments: >
            -Rid "${{ target.rid }}"
            -Target "${{ parameters.TargetDirectory }}"
            -ArtifactStagingDirectory "$(Build.ArtifactStagingDirectory)"
            -Framework "${{ target.framework }}"
          pwsh: true
        displayName: 'Produce Executable for ${{ target.rid }}'
        env:
          DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
          DOTNET_MULTILEVEL_LOOKUP: 0
      
      - template: /eng/common/pipelines/templates/steps/publish-artifact.yml
        parameters:
          ArtifactName: "standalone-${{ target.rid }}"
          ArtifactPath: "$(Build.ArtifactStagingDirectory)/${{ target.rid }}"

