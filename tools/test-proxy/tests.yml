# NOTE: Please refer to https://aka.ms/azsdk/engsys/ci-yaml before editing this file.
trigger:
  branches:
    include:
      - main
      - feature/*
      - release/*
      - hotfix/*
  paths:
    include:
      - tools/test-proxy

pr:
  branches:
    include:
      - main
      - feature/*
      - release/*
      - hotfix/*
  paths:
    include:
      - tools/test-proxy

variables:
  - template: /eng/pipelines/templates/variables/globals.yml

stages:
  - stage: IntegrationTests
    displayName: "Asset Sync Integration Tests"
    jobs:
    - job: Integration_Test

      strategy:
        matrix:
          Windows:
            Pool: 'azsdk-pool-mms-win-2019-general'
            OS: 'Windows'
          Linux:
            Pool: 'azsdk-pool-mms-ubuntu-2004-general'
            OS: 'Linux'
          Mac:
            Pool: 'Azure Pipelines'
            OS: 'Mac'

      pool:
        name: $(Pool)

      steps:
        - task: UseDotNet@2
          displayName: 'Use .NET Core sdk 6.x'
          inputs:
            version: '6.x'

        - script: 'dotnet test /p:ArtifactsPackagesDir=$(Build.ArtifactStagingDirectory) --logger trx $(Build.SourcesDirectory)/tools/test-proxy/'
          displayName: 'Test'
          env:
            DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
            DOTNET_CLI_TELEMETRY_OPTOUT: 1
            DOTNET_MULTILEVEL_LOOKUP: 0
            GITHUB_TOKEN: "faketoken"
        
        - task: PublishTestResults@2
          condition: succeededOrFailed()
          inputs:
            testResultsFiles: '**/*.trx'
            testRunTitle: '$(OS) AssetSync Tests against $(DotNetCoreVersion)'
            testResultsFormat: 'VSTest'
            mergeTestResults: true

  - stage: RepoUnitTests
    displayName: Repo-Specific Unit Tests
    dependsOn: []
    jobs:
    - job: Repo_Unit_Test

      strategy:
        matrix:
          Windows:
            Pool: 'azsdk-pool-mms-win-2019-general'
            OS: 'Windows'
          Linux:
            Pool: 'azsdk-pool-mms-ubuntu-2004-general'
            OS: 'Linux'
          Mac:
            Pool: 'Azure Pipelines'
            OS: 'Mac'

      pool:
        name: $(Pool)

      steps:
        - task: UseDotNet@2
          displayName: 'Use .NET Core sdk 6.x'
          inputs:
            version: '6.x'

        - script: 'dotnet test /p:ArtifactsPackagesDir=$(Build.ArtifactStagingDirectory) --logger trx $(Build.SourcesDirectory)/tools/test-proxy/'
          displayName: 'Test'
          env:
            DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
            DOTNET_CLI_TELEMETRY_OPTOUT: 1
            DOTNET_MULTILEVEL_LOOKUP: 0
            GITHUB_TOKEN: "faketoken"
        
        - task: PublishTestResults@2
          condition: succeededOrFailed()
          inputs:
            testResultsFiles: '**/*.trx'
            testRunTitle: '$(OS) Repo Tests against $(DotNetCoreVersion)'
            testResultsFormat: 'VSTest'
            mergeTestResults: true

