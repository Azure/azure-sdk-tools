trigger: none

schedules:
- cron: "0 0 * * *"
  displayName: Daily midnight build
  branches:
    include:
    - main
  always: true

pool:
  vmImage: 'windows-latest'

variables:
  aoai-endpoint: $(azure-openai-endpoint)
  asch-endpoint: $(azure-search-endpoint)
  asch-index-name: $(azure-search-index-name)
  aoai-embedding-model: $(azure-openai-embedding-model)

parameters:
- name: incrementalEmbedding
  displayName: 'Incremental Embedding Build?'
  type: boolean
  default: true

stages:
- stage: SetupEnvironment
  displayName: 'Setup Environment'
  jobs:
    - job: Setup
      steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.x'
          addToPath: true
      - checkout: self

- stage: BuildEngHubDocEmbeddings
  displayName: 'Build EngHub Document Embeddings'
  jobs:
  - job: Build EngHub Document Embeddings
    dependsOn: SetupEnvironment
    steps:
    - checkout: git://internal/_git/azure-sdk-docs-eng.ms
      displayName: 'Checkout azure-sdk-docs-eng.ms repository'    
    - task: Powershell@2
      inputs:
        filePath: $(Build.SourcesDirectory)/azure-sdk-tools/tools/sdk-ai-bots/Scripts/Build-EngHubDocEmbeddings.ps1
        arguments: >
          -IncrementalEmbedding "${{ parameters.incrementalEmbedding }}"
        pwsh: true
        workingDirectory: $(Build.SourcesDirectory)
      displayName: 'Run embeddings build script'
      env:
        AZURE_OPENAI_ENDPOINT: $(aoai-endpoint)
        AZURE_SEARCH_ENDPOINT: $(asch-endpoint)
        AZURE_SEARCH_INDEX_NAME: $(asch-index-name)
        AZURE_OPENAI_EMBEDDING_MODEL: $(aoai-embedding-model)
        AZURE_OPENAI_API_KEY: $(azure-openapi-key)
        AZURE_SEARCH_KEY: $(azure-search-key)
        AZURE_STORAGE_ACCOUNT_KEY: $(storage-account-key)