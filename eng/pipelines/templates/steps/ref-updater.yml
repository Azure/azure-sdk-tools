# Updates repository Refs on all pipelines
parameters:
  Tag: ''
  ToolRepo: ''
  ToolsRepoPath: ''
  Repos: []

steps:
- ${{ each repo in parameters.Repos }}:
  - pwsh: |
      git clone https://github.com/azure/${{ repo.key }}
      if ("${{ repo.value.branch }}")
      {
        Write-Host "git checkout -b ${{ repo.value.branch }} origin/${{ repo.value.branch }}"
        git checkout -b ${{ repo.value.branch }} origin/${{ repo.value.branch }}
      }
    displayName: Clone ${{ repo.key }}
    workingDirectory: $(System.DefaultWorkingDirectory)
  - template: /eng/common/pipelines/templates/steps/set-default-branch.yml
  - task: Powershell@2
    inputs:
      targetType: 'filePath'
      filePath: ${{ parameters.ToolsRepoPath }}/scripts/powershell/ref-updater.ps1
      arguments: >
        -RepoRoot $(System.DefaultWorkingDirectory)/${{ repo.key }}
        -Tag ${{ parameters.Tag }}
        -ToolRepo ${{ parameters.ToolRepo }}
      pwsh: true
    displayName: Update Refs

  - template: ../../../common/pipelines/templates/steps/create-pull-request.yml
    parameters:
      RepoName: ${{ repo.key }}
      PRBranchName: UpdateRepositoryRefsFor${{ parameters.ToolRepo }}
      CommitMsg: Update ${{ parameters.ToolRepo }} Repository Resource Refs in Yaml files
      PRTitle: Update ${{ parameters.ToolRepo }} Repository Resource Refs in Yaml files
      PushArgs: -f
      WorkingDirectory: $(System.DefaultWorkingDirectory)/${{ repo.key }}
      ScriptDirectory: ${{ parameters.ToolsRepoPath }}/eng/common/scripts
      ${{ if ne(repo.value.branch, '') }}:
        BaseBranchName: ${{ repo.value.branch }}
      ${{ if eq(repo.value.branch, '') }}:
        BaseBranchName: $(DefaultBranch)
