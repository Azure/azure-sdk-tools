# Configure notifications in Azure DevOps
trigger: none

pr: none

stages:
- stage: Run

  variables:
  - template: ./templates/variables/globals.yml

  jobs:
  - job: Run
    timeoutInMinutes: 120
    pool:
      name: azsdk-pool-mms-ubuntu-2204-general
      vmImage: MMSUbuntu22.04

    variables:
      Organization: azure-sdk
      Project: internal
      DotNetDevOpsFeed: "https://pkgs.dev.azure.com/azure-sdk/public/_packaging/azure-sdk-for-net/nuget/v3/index.json"
      OutputPath: '$(Agent.BuildDirectory)/pipelineOwners.json'
    steps:
      - task: DotNetCoreCLI@2
        displayName: 'Build Pipeline Owners Extractor'
        inputs:
          command: build
          arguments: 'tools\pipeline-owners-extractor\Azure.Sdk.Tools.PipelineOwnersExtractor\Azure.Sdk.Tools.PipelineOwnersExtractor.csproj'
          # workingDirectory: '$(Agent.BuildDirectory)'
      - pwsh: |
              Write-Host "Agent.BuildDirectory - ""$(Agent.BuildDirectory)"""
              Get-ChildItem $(Agent.BuildDirectory) | ForEach-Object { Write-Host $_ }
              Write-Host "Parent - "
              Get-ChildItem "$(Agent.BuildDirectory)/.." | ForEach-Object { Write-Host $_ }
              Write-Host "Curr dir - $(Get-Location)"
              Get-ChildItem "$(Get-Location)" | ForEach-Object { Write-Host $_ }
              Write-Host "Debug net 6.0 - "
              Get-ChildItem "artifacts/bin/Azure.Sdk.Tools.PipelineOwnersExtractor/Debug/net6.0" | ForEach-Object { Write-Host $_ }      
        displayName: "Display paths"
      - task: AzureCLI@2
        displayName: Run Pipeline Owners Extractor
        inputs:
          azureSubscription: 'Azure SDK Engineering System'
          scriptType: pscore
          scriptLocation: inlineScript
          inlineScript: dotnet artifacts/bin/Azure.Sdk.Tools.PipelineOwnersExtractor/Debug/net6.0/Azure.Sdk.Tools.PipelineOwnersExtractor.dll --output "$(OutputPath)"
      - publish: $(OutputPath)
        displayName: Publish pipelineOwners artifact
        artifact: pipelineOwners
        condition: succeededOrFailed()
