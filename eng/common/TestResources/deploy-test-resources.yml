parameters:
  ServiceDirectory: not-set
  ArmTemplateParameters: '@{}'
  DeleteAfterHours: 24
  Location: ''
  SubscriptionConfiguration: sub-config-azure-cloud-test-resources

# Format: sub-config-<cloud name>-<subscription name>
# Subscription configuration includes $Environment

  # SubscriptionId:
  # TenantId:
  # TestApplicationId:
  # TestApplicationSecret:
  # TestApplicationOid:
  # ProvisionerApplicationId:
  # ProvisoinerApplicationSecret:
  # Environment: AzureCloud, AzureUSGovernment, AzureChinaCloud, AzureStackRedmond

steps:
  # New-TestResources command requires Az module
  - pwsh: Install-Module -Name Az -Scope CurrentUser -AllowClobber -Force -Verbose
    displayName: Install Azure PowerShell module

  # On MacOS there are problems with access to the ~/.Azure folder. This
  # workaround fixes the problem.
  - bash: sudo rm -rf ~/.Azure
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))
    displayName: Clean out ~/.Azure

  - pwsh: >
      eng/common/TestResources/New-TestResources.ps1
      -BaseName 'Generated'
      -ServiceDirectory ${{ parameters.ServiceDirectory }}
      -Location '${{ parameters.Location }}'
      -DeleteAfterHours ${{ parameters.DeleteAfterHours }}
      -AdditionalParameters ${{ parameters.ArmTemplateParameters }}
      -SubscriptionConfiguration ${{ parameters.SubscriptionConfiguration }}
      -KeyVaultName $(provisioner-keyvault-name)
      -KeyVaultTenantId $(provisioner-aad-tenant)
      -KeyVaultAppId $(provisioner-aad-id)
      -KeyVaultAppSecret $(provisioner-aad-secret)
      -CI
      -Force
      -Verbose
    displayName: Deploy test resources
