parameters:
- name: BuildStages
  type: object
  default: []
- name: BuildStageName
  type: string
  default: ''
- name: ArtifactName
  type: string
  default: ''
- name: PackageJsonPath
  type: string
  default: ''


extends:
  template: /eng/pipelines/templates/stages/1es-redirect.yml
  parameters:
    GenerateBaselines: true
    stages:
      - ${{ parameters.BuildStages }}

      # only include if running on `internal` build with manual queue, otherwise never include
      - ${{ if and(in(variables['Build.Reason'], 'Manual', ''), eq(variables['System.TeamProject'], 'internal'))}}:
        - stage: Publish
          displayName: Publish
          dependsOn: ${{ parameters.BuildStageName }}

          jobs:
            - job: PrePublish
              variables:
                - template: /eng/pipelines/templates/variables/image.yml
              pool:
                name: $(LINUXPOOL)
                image: $(LINUXVMIMAGE)
                os: linux
              steps:
                - checkout: self

                - download: current
                  artifact: ${{ parameters.ArtifactName }}
                  timeoutInMinutes: 5

                - task: PowerShell@2
                  inputs:
                    filePath: '$(Build.SourcesDirectory)/eng/scripts/determine-js-release-tag.ps1'
                    failOnStderr: true
                    pwsh: true
                    arguments: '-PackageJsonPath ${{ parameters.PackageJsonPath }}'

                - pwsh: |
                    Write-Host "Will deploy with tag of $(Tag)"
                    Get-ChildItem "$(Pipeline.Workspace)/${{ parameters.ArtifactName }}" -Recurse -Force `
                      | Where-Object { $_.Name -like "*.tgz" } `
                      | Copy-Item -Destination "$(Build.ArtifactStagingDirectory)"

                    Get-ChildItem "$(Build.ArtifactStagingDirectory)" -Recurse -Force | % { Write-Host $_.FullName }
                    echo "##vso[task.setvariable variable=Tag;isOutput=true]$(Tag)"
                  name: SetTag
                  displayName: Move artifact to $(Build.ArtifactStagingDirectory)

            - template: /eng/common/pipelines/templates/jobs/npm-release-task.yml
              parameters:
                Artifact:
                  name: ${{ replace( parameters.ArtifactName, '-', '_') }}
                  path: $(Pipeline.Workspace)/${{ parameters.ArtifactName }}
                PathToArtifacts: $(Pipeline.Workspace)/${{ parameters.ArtifactName }}
                Registry: 'https://registry.npmjs.org/'
                TopLevelArtifactName: ${{ parameters.ArtifactName }}
                VarDependencies:
                  Tag: "$[dependencies.PrePublish.outputs['SetTag.Tag']]"
                DependsOn:
                  - 'PrePublish'
