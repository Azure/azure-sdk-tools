<ng-container *ngIf="loadingStatus === 'completed'; else loadingOrFailedTemplate">
    <div class="px-1 pt-4">
        <h6 class="mb-2 fw-semibold">Approval</h6>
        <div class="text-center py-2">
            <ng-container *ngIf="canApproveForReviewLanguage">
                <ng-container *ngIf="canToggleApproveAPIRevision; else cantToggleApproveAPIRevision">
                    <span *ngIf="apiRevisionApprovalMessage" class="small text-muted">{{apiRevisionApprovalMessage}}</span>
                    <div class="d-grid gap-2">
                        <button class="{{apiRevisionApprovalBtnClass}}" type="button"
                            (click)="handleAPIRevisionApprovalAction()"
                            [disabled]="isAPIRevisionApprovalDisabled">{{apiRevisionApprovalBtnLabel}}</button>
                    </div>
                </ng-container>
                <ng-template #cantToggleApproveAPIRevision>
                    <div class="d-grid gap-2" pTooltip="API Revision cannot be approved when comparing against unapproved revision."
                        tooltipPosition="bottom">
                        <button class="{{apiRevisionApprovalBtnClass}}" type="button"
                            disabled>
                            {{apiRevisionApprovalBtnLabel}}
                        </button>
                    </div>
                </ng-template>
            </ng-container>
            <span *ngIf="activeAPIRevision && activeAPIRevision!.approvers.length > 0; else noAPIRevisionApprovers" class="small text-muted mt-1">
                Approved by: <a *ngFor="let approver of activeAPIRevision!.approvers" href="{{webAppUrl}}Assemblies/Profile/{{approver}}">{{approver}},&nbsp;</a>
            </span>
            <ng-template #noAPIRevisionApprovers>
                <span class="small text-muted mt-1">Current Revision approval pending</span>
            </ng-template>
        </div>
        <div class="text-center py-2" *ngIf="review?.language !== 'TypeSpec' && review?.language !== 'Swagger'">
            <ng-container *ngIf="reviewIsApproved; else reviewIsNotApproved">
                <span class="small text-muted mt-1" id="first-release-approval-message">Approved for first release by: <a href="{{webAppUrl}}Assemblies/Profile/{{reviewApprover}}">{{reviewApprover}}</a></span>
            </ng-container>
            <ng-template #reviewIsNotApproved>
                <div *ngIf="canApproveForReviewLanguage; else userIsNotAPreferredApprover">
                    <span class="small text-muted">Approves first release of the package</span>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" type="button" id="first-release-approval-button"
                            (click)="handleReviewApprovalAction()"
                            pTooltip="Package name must be approved before first preview release of a new package."
                            tooltipPosition="bottom"
                            data-clarity-region="approve-namespace-button">
                            Approve first release
                        </button>
                    </div>
                    <span class="small mt-2 text-muted" id="first-release-approval-message">First release approval pending</span>
                </div>
            </ng-template>
            <ng-template #userIsNotAPreferredApprover>
                <span class="small mt-2 text-muted" id="first-release-approval-message">First release approval pending</span>
            </ng-template>
        </div>
        <div class="text-center py-2" *ngIf="canRequestNamespaceReview">
            <div class="d-grid gap-2">
                <button class="{{namespaceReviewBtnClass}}" type="button"
                        (click)="handleNamespaceReviewAction()"
                        [disabled]="isNamespaceReviewRequested || isNamespaceApproved() || isNamespaceReviewInProgress"
                        data-clarity-region="request-namespace-review-button">
                    <span *ngIf="isNamespaceReviewInProgress" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    {{namespaceReviewBtnLabel}}
                </button>
            </div>
            <span *ngIf="namespaceReviewMessage" class="small text-muted mt-2 d-block">{{namespaceReviewMessage}}</span>
        </div>
    </div>

    <hr class="my-2">
    <div class="px-1 py-2">
        <div class="d-flex justify-content-between align-items-center mb-2 cursor-pointer"
            role="button"
            tabindex="0"
            aria-label="Select reviewers"
            data-clarity-region="reviewers-gear"
            (click)="reviewersPanel.toggle($event)"
            (keydown.enter)="reviewersPanel.toggle($event)"
            (keydown.space)="reviewersPanel.toggle($event); $event.preventDefault()">
            <h6 class="mb-0 fw-semibold">Reviewers</h6>
            <span class="btn btn-link p-0 text-muted" aria-hidden="true" tabindex="-1" title="Select reviewers">
                <i class="bi bi-gear"></i>
            </span>
        </div>
        <div *ngIf="selectedApprovers.length > 0; else noReviewers">
            <div *ngFor="let approver of selectedApprovers" class="d-flex align-items-center py-1">
                <img src="https://github.com/{{ approver }}.png?size=30" class="me-2 rounded-circle" width="20" height="20" [attr.alt]="approver + ' avatar'" />
                <span class="small">{{ approver }}</span>
            </div>
        </div>
        <ng-template #noReviewers>
            <span class="small text-muted">No reviewers assigned</span>
        </ng-template>
    </div>

    <p-popover #reviewersPanel styleClass="reviewers-panel" (onHide)="resetReviewerSearch()">
        <ng-template pTemplate="content">
            <div style="width: 300px;">
                <div class="p-2 border-bottom">
                    <div class="position-relative">
                        <input type="text"
                            class="form-control form-control-sm pe-4"
                            placeholder="Type or choose a user"
                            aria-label="Search reviewers"
                            [(ngModel)]="reviewerSearchText"
                            (input)="filterReviewers()">
                        <button *ngIf="reviewerSearchText"
                            type="button"
                            class="btn btn-link btn-sm position-absolute end-0 top-50 translate-middle-y p-0 me-2 text-muted"
                            (click)="resetReviewerSearch()"
                            aria-label="Clear search">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="reviewer-list" style="max-height: 300px; overflow-y: auto;">
                    <div *ngIf="filteredApprovers.length === 0" class="px-3 py-2 text-muted small">
                        Nothing to show
                    </div>
                    <div *ngFor="let approver of filteredApprovers"
                        class="d-flex align-items-center px-3 py-2 reviewer-item cursor-pointer"
                        [class.selected]="selectedApprovers.includes(approver)"
                        role="checkbox"
                        [attr.aria-checked]="selectedApprovers.includes(approver)"
                        tabindex="0"
                        (click)="toggleReviewer(approver)"
                        (keydown.enter)="toggleReviewer(approver)"
                        (keydown.space)="toggleReviewer(approver); $event.preventDefault()">
                        <i class="bi bi-check me-2" style="font-size: 1.25rem;" [style.visibility]="selectedApprovers.includes(approver) ? 'visible' : 'hidden'" aria-hidden="true"></i>
                        <img src="https://github.com/{{ approver }}.png?size=30" class="me-2 rounded-circle" width="20" height="20" [attr.alt]="approver + ' avatar'" />
                        <span class="small">{{ approver }}</span>
                    </div>
                </div>
            </div>
        </ng-template>
    </p-popover>

    <ng-container *ngIf="review && userProfile && userProfile.userName && isCopilotReviewSupported">
        <hr class="my-2">
        <div class="px-1 py-2">
            <h6 class="mb-2 fw-semibold">Copilot</h6>
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-outline-primary" tooltipPosition="top" [disabled]="generateAIReviewButtonText === AI_REVIEW_BUTTON_TEXT.GENERATING" (click)="generateAIReview()" data-clarity-region="generate-copilot-review-button">
                    <i *ngIf="aiReviewGenerationState === 'NotStarted' || aiReviewGenerationState == 'Completed'" class="bi bi-stars"></i>
                    <div *ngIf="aiReviewGenerationState == 'InProgress'" class="spinner-grow spinner-grow-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    {{ generateAIReviewButtonText }}
                </button>
            </div>
        </div>
    </ng-container>

    <hr class="my-2">
    <div class="px-1 py-2">
        <h6 class="mb-2 fw-semibold">Notifications</h6>
        <div class="d-grid gap-2">
            <button type="button"
                [ngClass]="subscribeSwitch ? 'btn btn-primary' : 'btn btn-outline-primary'"
                (click)="onSubscribeButtonClick()"
                data-clarity-region="toggle-subscribe">
                <i class="bi" [ngClass]="subscribeSwitch ? 'bi-bell-slash' : 'bi-bell'"></i>
                {{ subscribeSwitch ? 'Unsubscribe' : 'Subscribe' }}
            </button>
        </div>
        <span class="small text-muted mt-2 d-block">
            {{ subscribeSwitch ? 'You\'re receiving notifications for this review.' : 'You\'re not receiving notifications for this review.' }}
        </span>
    </div>

    <ng-container *ngIf="associatedPullRequests.length > 0">
        <hr class="my-2">
        <div class="px-1 py-2">
            <h6 class="mb-2 fw-semibold">Associated Pull Requests</h6>
            <div *ngFor="let pullRequest of associatedPullRequests" class="py-1">
                <a href="https://github.com/{{pullRequest.repoName}}/pull/{{pullRequest.pullRequestNumber}}" target="_blank">{{pullRequest.repoName}}/{{pullRequest.pullRequestNumber}}</a>
            </div>
        </div>
    </ng-container>

    <ng-container *ngIf="pullRequestsOfAssociatedAPIRevisions.length > 0">
        <hr class="my-2">
        <div class="px-1 py-2">
            <h6 class="mb-2 fw-semibold">Associated API Revisions</h6>
            <div *ngFor="let pullRequest of pullRequestsOfAssociatedAPIRevisions" class="py-1">
                <span>
                    <img src="{{assetsPath}}/images/{{ pullRequest.language | languageNames: userProfile?.preferences?.theme }}-original.svg" class="me-2" width="20" height="20">
                    <a [href]="getPullRequestsOfAssociatedAPIRevisionsUrl(pullRequest)" target="_blank"><small>{{pullRequest.packageName}}</small></a>
                </span>
            </div>
        </div>
    </ng-container>

    <ng-container *ngIf="isAdmin">
        <hr class="my-2">
        <div class="px-1 py-2">
            <h6 class="mb-2 fw-semibold">Admin Actions</h6>
            <div class="d-grid gap-2">
                <button *ngIf="(aiReviewGenerationState == 'Completed' || activeAPIRevision?.hasAutoGeneratedComments) && isCopilotReviewSupported" type="button" class="btn btn-outline-danger" (click)="clearAutoGeneratedComments()">
                    <i class="bi bi-x-lg me-2"></i>Clear copilot comments
                </button>
                <button type="button"
                    class="btn btn-outline-danger"
                    (click)="deleteReview()"
                    pTooltip="Delete this review and all its revisions"
                    tooltipPosition="top"
                    data-clarity-region="delete-review-button">
                    <i class="bi bi-trash"></i> Delete Review
                </button>
            </div>
        </div>
    </ng-container>



    <p-dialog header="Approve APIRevision"
    [modal]="true" [(visible)]="showAPIRevisionApprovalModal"
    [style]="{ width: '40dvw' }">
    <ul class="list-group">
        <li class="list-group-item" *ngIf="hasActiveConversation">
            <div class="float-start">
                <p class="mb-0">There are still active conversations. Would you like to review these first?</p>
            </div>
            <div class="float-end">
                <p-toggleswitch [(ngModel)]="overrideActiveConversationforApproval"/>
                <label class="ms-2">Override</label>
            </div>
        </li>
        <li class="list-group-item" *ngIf="hasFatalDiagnostics">
            <div class="float-start">
                <p class="mb-0">This API has fatal diagnostics.</p>
            </div>
            <div class="float-end">
                <p-toggleswitch [(ngModel)]="overrideFatalDiagnosticsforApproval"/>
                <label class="ms-2">Override</label>
            </div>
        </li>
      </ul>
      <div class="d-grid gap-2 mt-2">
        <button class="btn btn-success" type="button"
            (click)="toggleAPIRevisionApproval()"
            [disabled]="(hasActiveConversation && !overrideActiveConversationforApproval) || (hasFatalDiagnostics && !overrideFatalDiagnosticsforApproval)">Confirm</button>
      </div>
    </p-dialog>
</ng-container>
<ng-template #loadingOrFailedTemplate>
    <div *ngIf="loadingStatus === 'loading'" class="spinner-border m-3" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</ng-template>
