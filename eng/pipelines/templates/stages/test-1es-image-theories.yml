extends:
  template: /eng/pipelines/templates/stages/1es-redirect.yml
  parameters:
    stages:
      - stage: 'Investigate'
        variables:
          - template: /eng/pipelines/templates/variables/globals.yml
          - template: /eng/pipelines/templates/variables/image.yml
        jobs:
          - job: 'MacOS'

            pool:
              name: $(MACPOOL)
              vmImage: $(MACVMIMAGE)
              os: macOS

            steps:
              - pwsh: |
                  dotnet --list-sdks
                displayName: 'Run dotnet --list-sdks'

              - template: /eng/common/testproxy/test-proxy-tool.yml

              - template: /eng/common/testproxy/test-proxy-tool-shutdown.yml

              - pwsh: |
                  $files = Get-ChildItem -Path $(Build.SourcesDirectory) -Filter test-proxy.log
                  foreach($file in $files){
                      Write-Host "##[group]$file"
                      cat $file
                      Write-Host "##[endgroup]"
                  }
                displayName: Dump Test-Proxy Logs
                condition: succeededOrFailed()

              - pwsh: |
                  $files = Get-ChildItem -Path $(Build.SourcesDirectory) -Filter test-proxy-error.log
                  foreach($file in $files){
                      Write-Host "##[group]$file"
                      cat $file
                      Write-Host "##[endgroup]"
                  }
                displayName: Dump Test-Proxy Error Logs
                condition: succeededOrFailed()

          - job: 'Windows'

            pool:
              name: $(WINDOWSPOOL)
              image: $(WINDOWSVMIMAGE)
              os: windows

            steps:
              - pwsh: |
                  dotnet --list-sdks
                displayName: 'Run dotnet --list-sdks'

              - template: /eng/common/testproxy/test-proxy-tool.yml

              - template: /eng/common/testproxy/test-proxy-tool-shutdown.yml

              - pwsh: |
                  $files = Get-ChildItem -Path $(Build.SourcesDirectory) -Filter test-proxy.log
                  foreach($file in $files){
                      Write-Host "##[group]$file"
                      cat $file
                      Write-Host "##[endgroup]"
                  }
                displayName: Dump Test-Proxy Logs
                condition: succeededOrFailed()

              - pwsh: |
                  $files = Get-ChildItem -Path $(Build.SourcesDirectory) -Filter test-proxy-error.log
                  foreach($file in $files){
                      Write-Host "##[group]$file"
                      cat $file
                      Write-Host "##[endgroup]"
                  }
                displayName: Dump Test-Proxy Error Logs
                condition: succeededOrFailed()

          - job: 'Linux'

            pool:
              name: $(LINUXPOOL)
              image: $(LINUXVMIMAGE)
              os: linux

            steps:
              - pwsh: |
                  dotnet --list-sdks
                displayName: 'Run dotnet --list-sdks'

              - template: /eng/common/testproxy/test-proxy-tool.yml

              - template: /eng/common/testproxy/test-proxy-tool-shutdown.yml

              - pwsh: |
                  $files = Get-ChildItem -Path $(Build.SourcesDirectory) -Filter test-proxy.log
                  foreach($file in $files){
                      Write-Host "##[group]$file"
                      cat $file
                      Write-Host "##[endgroup]"
                  }
                displayName: Dump Test-Proxy Logs
                condition: succeededOrFailed()

              - pwsh: |
                  $files = Get-ChildItem -Path $(Build.SourcesDirectory) -Filter test-proxy-error.log
                  foreach($file in $files){
                      Write-Host "##[group]$file"
                      cat $file
                      Write-Host "##[endgroup]"
                  }
                displayName: Dump Test-Proxy Error Logs
                condition: succeededOrFailed()