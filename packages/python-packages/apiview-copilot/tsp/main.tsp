import "@typespec/rest";

using TypeSpec.Http;

@service(#{ title: "APIView Copilot Service" })
namespace ApiViewCopilot {
  /** Requests a synchronous API review */
  #deprecated "Use /api-review/start instead"
  @route("/{language}")
  @post
  op legacyApiReview(
    @path language: string,
    @body request: ApiReviewRequest,
    @header("Authorization") authorization: string,
  ): ApiReviewResponse;

  /** Starts a new API review job */
  @route("/api-review/start")
  @post
  op startApiReviewJob(
    @body request: ApiReviewJobRequest,
    @header("Authorization") authorization: string,
  ): ApiReviewJobStartResponse;

  /** Gets the status of an API review job */
  @route("/api-review/{jobId}")
  @get
  op getApiReviewJobStatus(
    @path jobId: string,
    @header("Authorization") authorization: string,
  ): ApiReviewJobStatusResponse;

  /** Summarizes an API or the diff between two APIs */
  @route("/api-review/summarize")
  @post
  op summarizeApi(
    @body request: SummarizeRequest,
    @header("Authorization") authorization: string,
  ): SummarizeResponse;

  /** Submit a chat message to the agent. */
  @route("/agent/chat")
  @post
  op agentChat(
    @body request: AgentChatRequest,
    @header("Authorization") authorization: string,
  ): AgentChatResponse;

  /** Handles an @mention from APIView. */
  @route("/api-review/mention")
  @post
  op handleMention(
    @body request: MentionRequest,
    @header("Authorization") authorization: string,
  ): AgentChatResponse;

  /** Handles the resolution of a chat thread from APIView. */
  @route("/api-review/resolve")
  @post
  op handleResolve(
    @body request: MentionRequest,
    @header("Authorization") authorization: string,
  ): AgentChatResponse;

  /** Resolves package information from a package description and language. */
  @route("/api-review/resolve-package")
  @post
  op resolvePackage(
    @body request: ResolvePackageRequest,
    @header("Authorization") authorization: string,
  ): ResolvePackageResponse;

  /** Test endpoint to verify authentication is working. */
  @route("/auth-test")
  @get
  op authTest(
    @header("Authorization") authorization: string,
  ): { status: "ok" };

  /** Health check endpoint to verify service is running. */
  @route("/health-test")
  @get
  op healthCheck(): { status: "ok" };

  model MentionRequest {
    /** The programming language of the APIView. */
    language: string;

    /** The name of the package in question */
    packageName: string;

    /** The code line being discussed */
    code: string;

    /** The comments in the APIView thread. */
    comments: ApiViewComment[];
  }

  model ApiReviewRequest {
    /** The API specification to review */
    target: string;

    /** The base API specification to compare against */
    base?: string;

    /** The outline of the API to review */
    outline?: string;

    /** Any existing comments on the API */
    comments?: ApiViewComment[];
  }

  model ApiReviewResponse {
    /** The list of review comments */
    comments: ReviewComment[];
  }

  /** An existing comment in APIView */
  model ApiViewComment {
    /** The line number of the comment */
    lineNo: int32;

    /** The datetime the comment was created */
    createdOn: offsetDateTime;

    /** The count of upvotes */
    upvotes?: int32;

    /** The count of downvotes */
    downvotes?: int32;

    /** The creator of the comment */
    createdBy: string;

    /** The contents of the comment */
    commentText: string;

    /** Whether the comment is marked resolved */
    isResolved?: boolean;
  }

  /** A review comment generated by Copilot */
  model ReviewComment {
    /** The applicable guideline IDs relevant to this comment */
    guidelineIds: string[];

    /** The applicable memory IDs relevant to this comment */
    memoryIds: string[];

    /** Whether the comment is entirely or in part formed from generic guidance */
    isGeneric: boolean;

    /** The line number of the comment */
    lineNo: int32;

    /** The offending code */
    badCode: string;

    /** Suggested code to improve the bad_code */
    suggestion?: string;

    /** The contents of the comment */
    comment: string;

    /** An ID that correlates this comment with other related comments */
    correlationId?: string;
    
    /** A score from 0 to 1 estimating the confidence in this comment's validity */
    confidenceScore?: float32;

    /** The severity level of the comment */
    severity: "SUGGESTION" | "SHOULD" | "MUST" | "QUESTION";
  }

  model ApiReviewJobRequest {
    /** The programming language of the APIView */
    language: string;

    ...ApiReviewRequest;
  }

  model ApiReviewJobStartResponse {
    /** The unique identifier for the job */
    jobId: string;
  }

  model ApiReviewJobStatusResponse {
    /** The current status of the job */
    status: "InProgress" | "Success" | "Error";

    /** The review comments, if the status is Success. `null` while InProgress. */
    comments?: ReviewComment[];

    /** Error details if the status is Error. `null` while InProgress. */
    details?: string;
  }

  model SummarizeRequest {
    /** The programming language of the involved APIViews. */
    language: string;

    /** The target APIView to summarize. */
    target: string;

    /** The base APIView to compare against. If provided, the summary will be a summary of the diff between target and base. */
    base?: string;
  }

  model SummarizeResponse {
    /** The summary of the APIView or the summary of the diff between two APIViews. */
    summary: string;
  }

  model AgentChatRequest {
    /** The user's input message to the agent. */
    userInput: string;

    /** The ID of the thread to continue the conversation. If `null` a new thread will be created. */
    threadId?: string;

    /** The list of messages in the conversation. */
    messages?: {}[];
  }

  model AgentChatResponse {
    /** The agent's response to the user's message. */
    response: string;

    /** The ID of the thread for the conversation. */
    threadId: string;

    /** The list of messages in the conversation. */
    messages: {}[];
  }

  model ResolvePackageRequest {
    /** The package description or name to search for. */
    packageQuery: string;

    /** The programming language of the package (e.g., 'python', 'java'). */
    language: string;

    /** Optional version to filter by. If not provided, returns the latest revision. */
    version?: string;

    /** The APIView environment ('production' or 'staging'). Defaults to 'production'. */
    environment?: "production" | "staging";
  }

  model ResolvePackageResponse {
    /** The resolved package name. */
    packageName: string;

    /** The review ID for the package. */
    reviewId: string;

    /** The programming language. */
    language: string;

    /** The package version. */
    version?: string;

    /** The revision ID for the package. */
    revisionId?: string;

    /** The revision label (e.g., 'Source Branch:main'). */
    revisionLabel?: string;
  }
}
